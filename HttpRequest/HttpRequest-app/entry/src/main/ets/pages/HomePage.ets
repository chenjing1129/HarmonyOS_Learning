/**
 * é¦–é¡µ - çŽ©å®‰å“å†…å®¹
 */
import { WanAndroidApi } from '../api/wanAndroidApi'
import { Article, Banner, PageData, HotKey } from '../type/WanAndroidType'
import { ThemeConstants } from '../common/constants/ThemeConstants'

@Component
export struct HomePage {
  @State articles: Article[] = []
  @State banners: Banner[] = []
  @State hotKeys: HotKey[] = []
  @State loading: boolean = false
  @State errorMessage: string = ''
  @State currentPage: number = 0
  @State hasMore: boolean = true
  private isDestroyed: boolean = false

  async aboutToAppear() {
    this.isDestroyed = false
    await this.loadData()
  }

  aboutToDisappear() {
    // æ ‡è®°ç»„ä»¶å·²é”€æ¯,é¿å…å¼‚æ­¥æ“ä½œç»§ç»­æ‰§è¡Œ
    this.isDestroyed = true
    // æ¸…ç†æ•°æ®,é‡Šæ”¾å†…å­˜
    this.articles = []
    this.banners = []
    this.hotKeys = []
  }

  /**
   * åŠ è½½æ•°æ®
   */
  async loadData() {
    if (this.isDestroyed) return

    this.loading = true
    this.errorMessage = ''

    try {
      console.info('å¼€å§‹åŠ è½½æ•°æ®...')

      // ä¸²è¡ŒåŠ è½½ä»¥å‡å°‘å†…å­˜åŽ‹åŠ›
      console.info('å¼€å§‹åŠ è½½æ–‡ç« æ•°æ®...')
      const articlesData = await WanAndroidApi.getArticleList(0)
      if (this.isDestroyed) return

      // å¤„ç†æ–‡ç« æ•°æ®
      if (articlesData) {
        this.articles = articlesData.datas.slice(0, 10) // é™åˆ¶åˆå§‹åŠ è½½æ•°é‡
        this.hasMore = !articlesData.over
        console.info(`æˆåŠŸåŠ è½½ ${this.articles.length} ç¯‡æ–‡ç« `)
      } else {
        this.errorMessage = 'èŽ·å–æ–‡ç« å¤±è´¥'
        console.error('æ–‡ç« æ•°æ®é”™è¯¯')
        return
      }

      // åŠ è½½Banneræ•°æ®
      console.info('å¼€å§‹åŠ è½½Banneræ•°æ®...')
      const bannersData = await WanAndroidApi.getBanner()
      if (this.isDestroyed) return

      if (bannersData) {
        this.banners = bannersData.slice(0, 3) // é™åˆ¶Banneræ•°é‡
        console.info(`æˆåŠŸåŠ è½½ ${this.banners.length} ä¸ªBanner`)
      } else {
        console.warn('BanneråŠ è½½å¤±è´¥')
      }

      // åŠ è½½çƒ­è¯æ•°æ®
      console.info('å¼€å§‹åŠ è½½çƒ­è¯æ•°æ®...')
      const hotKeysData = await WanAndroidApi.getHotKeys()
      if (this.isDestroyed) return

      if (hotKeysData) {
        this.hotKeys = hotKeysData.slice(0, 10) // é™åˆ¶çƒ­è¯æ•°é‡
        console.info(`æˆåŠŸåŠ è½½ ${this.hotKeys.length} ä¸ªçƒ­è¯`)
      } else {
        console.warn('çƒ­è¯åŠ è½½å¤±è´¥')
      }

      console.info('æ‰€æœ‰æ•°æ®åŠ è½½å®Œæˆ')

    } catch (error) {
      if (this.isDestroyed) return
      console.error('Load data error:', error)

      // æ ¹æ®é”™è¯¯ç±»åž‹æä¾›æ›´å…·ä½“çš„é”™è¯¯ä¿¡æ¯
      if (typeof error === 'string') {
        this.errorMessage = error
      } else {
        this.errorMessage = 'ç½‘ç»œè¯·æ±‚å¤±è´¥,è¯·æ£€æŸ¥ç½‘ç»œè¿žæŽ¥'
      }
    } finally {
      if (!this.isDestroyed) {
        this.loading = false
      }
    }
  }

  /**
   * åŠ è½½æ›´å¤šæ–‡ç« 
   */
  async loadMoreArticles() {
    if (this.loading || !this.hasMore || this.isDestroyed) return

    this.loading = true
    try {
      const response = await WanAndroidApi.getArticleList(this.currentPage + 1)
      if (this.isDestroyed) return

      if (response) {
        // é™åˆ¶æ€»æ–‡ç« æ•°é‡,é¿å…å†…å­˜è¿‡è½½
        const newArticles = response.datas.slice(0, 10)
        const totalArticles = [...this.articles, ...newArticles]

        // å¦‚æžœæ–‡ç« æ€»æ•°è¶…è¿‡50,ç§»é™¤æœ€æ—§çš„æ–‡ç« 
        if (totalArticles.length > 50) {
          this.articles = totalArticles.slice(-50)
        } else {
          this.articles = totalArticles
        }

        this.currentPage++
        this.hasMore = !response.over
      }
    } catch (error) {
      if (this.isDestroyed) return
      console.error('Load more error:', error)
    } finally {
      if (!this.isDestroyed) {
        this.loading = false
      }
    }
  }

  /**
   * åˆ·æ–°æ•°æ®
   */
  async refreshData() {
    if (this.isDestroyed) return

    this.currentPage = 0
    this.articles = []
    this.banners = []
    this.hotKeys = []
    await this.loadData()
  }

  build() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Text('çŽ©å®‰å“')
          .fontSize(ThemeConstants.FONT_SIZE_LG)
          .fontWeight(FontWeight.Bold)
          .fontColor(ThemeConstants.TEXT_WHITE)
      }
      .width('100%')
      .height(ThemeConstants.NAVBAR_HEIGHT)
      .backgroundColor(ThemeConstants.PRIMARY_COLOR)
      .justifyContent(FlexAlign.Center)

      if (this.loading && this.articles.length === 0) {
        // åŠ è½½çŠ¶æ€
        Column() {
          LoadingProgress()
            .width(50)
            .height(50)
            .color(ThemeConstants.PRIMARY_COLOR)
          Text('åŠ è½½ä¸­...')
            .fontSize(ThemeConstants.FONT_SIZE_XS)
            .fontColor(ThemeConstants.TEXT_SECONDARY)
            .margin({ top: 10 })
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
      } else if (this.errorMessage) {
        // é”™è¯¯çŠ¶æ€
        Column() {
          Text('ðŸ˜ž')
            .fontSize(48)
          Text('ç½‘ç»œè¯·æ±‚å¤±è´¥')
            .fontSize(ThemeConstants.FONT_SIZE_MD)
            .fontWeight(FontWeight.Bold)
            .fontColor(ThemeConstants.TEXT_PRIMARY)
            .margin({ top: 10 })

          Text(this.errorMessage)
            .fontSize(ThemeConstants.FONT_SIZE_XS)
            .fontColor(ThemeConstants.TEXT_SECONDARY)
            .margin({ top: 8 })
            .textAlign(TextAlign.Center)
            .padding({ left: 20, right: 20 })

          Column() {
            Text('å¯èƒ½çš„è§£å†³æ–¹æ¡ˆ:')
              .fontSize(ThemeConstants.FONT_SIZE_BASE)
              .fontWeight(FontWeight.Medium)
              .margin({ top: 20, bottom: 10 })

            Text('1. æ£€æŸ¥è®¾å¤‡ç½‘ç»œè¿žæŽ¥')
              .fontSize(ThemeConstants.FONT_SIZE_XS)
              .fontColor(ThemeConstants.TEXT_SECONDARY)
              .margin({ bottom: 5 })
              .alignSelf(ItemAlign.Start)

            Text('2. ç¡®è®¤ç½‘ç»œæƒé™å·²æŽˆäºˆ')
              .fontSize(ThemeConstants.FONT_SIZE_XS)
              .fontColor(ThemeConstants.TEXT_SECONDARY)
              .margin({ bottom: 5 })
              .alignSelf(ItemAlign.Start)

            Text('3. å°è¯•åˆ‡æ¢ç½‘ç»œçŽ¯å¢ƒ')
              .fontSize(ThemeConstants.FONT_SIZE_XS)
              .fontColor(ThemeConstants.TEXT_SECONDARY)
              .margin({ bottom: 5 })
              .alignSelf(ItemAlign.Start)

            Text('4. æ£€æŸ¥é˜²ç«å¢™è®¾ç½®')
              .fontSize(ThemeConstants.FONT_SIZE_XS)
              .fontColor(ThemeConstants.TEXT_SECONDARY)
              .margin({ bottom: 20 })
              .alignSelf(ItemAlign.Start)
          }
          .padding({ left: 20, right: 20 })

          Button('é‡è¯•')
            .margin({ top: 10 })
            .backgroundColor(ThemeConstants.PRIMARY_COLOR)
            .onClick(() => this.refreshData())
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
      } else {
        // å†…å®¹åŒºåŸŸ
        Refresh({ refreshing: this.loading }) {
          List() {
            // BanneråŒºåŸŸ
            if (this.banners.length > 0) {
              ListItem() {
                this.BannerSection()
              }
            }

            // çƒ­è¯åŒºåŸŸ
            if (this.hotKeys.length > 0) {
              ListItem() {
                this.HotKeysSection()
              }
            }

            // æ–‡ç« åˆ—è¡¨
            ForEach(this.articles, (article: Article, index: number) => {
              ListItem() {
                this.ArticleItem(article)
              }
              .onClick(() => {
                console.info(`ç‚¹å‡»æ–‡ç« : ${article.title}`)
                // è¿™é‡Œå¯ä»¥è·³è½¬åˆ°æ–‡ç« è¯¦æƒ…é¡µæˆ–æ‰“å¼€æµè§ˆå™¨
              })
            })

            // åŠ è½½æ›´å¤š
            if (this.hasMore) {
              ListItem() {
                Row() {
                  if (this.loading) {
                    LoadingProgress()
                      .width(20)
                      .height(20)
                      .margin({ right: 10 })
                  }
                  Text(this.loading ? 'åŠ è½½ä¸­...' : 'ä¸Šæ‹‰åŠ è½½æ›´å¤š')
                    .fontSize(ThemeConstants.FONT_SIZE_XS)
                    .fontColor(ThemeConstants.TEXT_TERTIARY)
                }
                .width('100%')
                .height(50)
                .justifyContent(FlexAlign.Center)
              }
              .onClick(() => this.loadMoreArticles())
            } else if (this.articles.length > 0) {
              ListItem() {
                Row() {
                  Text('- æ²¡æœ‰æ›´å¤šäº† -')
                    .fontSize(ThemeConstants.FONT_SIZE_XXS)
                    .fontColor(ThemeConstants.TEXT_TERTIARY)
                }
                .width('100%')
                .height(50)
                .justifyContent(FlexAlign.Center)
              }
            }
          }
          .width('100%')
          .layoutWeight(1)
          .onReachEnd(() => {
            this.loadMoreArticles()
          })
        }
        .onRefreshing(() => this.refreshData())
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(ThemeConstants.BG_PAGE)
  }

  /**
   * Bannerç»„ä»¶
   */
  @Builder
  BannerSection() {
    Column() {
      Swiper() {
        ForEach(this.banners, (banner: Banner) => {
          Stack() {
            Image(banner.imagePath)
              .width('100%')
              .height(180)
              .objectFit(ImageFit.Cover)
              .borderRadius(ThemeConstants.BORDER_RADIUS_MD)
              .onError(() => {
                console.error('Banner image load failed:', banner.imagePath)
              })
              .onComplete(() => {
                console.info('Banner image loaded successfully')
              })

            Column() {
              Text(banner.title)
                .fontSize(ThemeConstants.FONT_SIZE_BASE)
                .fontColor(ThemeConstants.TEXT_WHITE)
                .fontWeight(FontWeight.Bold)
                .maxLines(2)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
            }
            .width('100%')
            .height('100%')
            .padding(ThemeConstants.SPACE_MD)
            .justifyContent(FlexAlign.End)
            .alignItems(HorizontalAlign.Start)
            .backgroundColor('rgba(0,0,0,0.3)')
            .borderRadius(ThemeConstants.BORDER_RADIUS_MD)
          }
          .onClick(() => {
            console.info(`ç‚¹å‡»Banner: ${banner.title}`)
          })
        })
      }
      .width('100%')
      .height(180)
      .autoPlay(true)
      .interval(3000)
      .indicator(true)
      .borderRadius(ThemeConstants.BORDER_RADIUS_MD)
    }
    .width('100%')
    .padding(ThemeConstants.SPACE_MD)
    .backgroundColor(ThemeConstants.BG_WHITE)
    .margin({ bottom: ThemeConstants.SPACE_XS })
  }

  /**
   * çƒ­è¯ç»„ä»¶
   */
  @Builder
  HotKeysSection() {
    Column() {
      Text('çƒ­é—¨æœç´¢')
        .fontSize(ThemeConstants.FONT_SIZE_BASE)
        .fontWeight(FontWeight.Bold)
        .margin({ bottom: ThemeConstants.SPACE_SM })
        .alignSelf(ItemAlign.Start)

      Flex({ wrap: FlexWrap.Wrap, alignItems: ItemAlign.Center }) {
        ForEach(this.hotKeys, (hotKey: HotKey) => {
          Text(hotKey.name)
            .fontSize(ThemeConstants.FONT_SIZE_XXS)
            .fontColor(ThemeConstants.PRIMARY_COLOR)
            .padding({ left: 12, right: 12, top: 6, bottom: 6 })
            .backgroundColor(ThemeConstants.PRIMARY_LIGHT_COLOR)
            .borderRadius(16)
            .margin({ right: ThemeConstants.SPACE_XS, bottom: ThemeConstants.SPACE_XS })
            .onClick(() => {
              console.info(`ç‚¹å‡»çƒ­è¯: ${hotKey.name}`)
              // è¿™é‡Œå¯ä»¥æ‰§è¡Œæœç´¢æ“ä½œ
            })
        })
      }
    }
    .width('100%')
    .padding(ThemeConstants.SPACE_MD)
    .backgroundColor(ThemeConstants.BG_WHITE)
    .margin({ bottom: ThemeConstants.SPACE_XS })
  }

  /**
   * æ–‡ç« é¡¹ç»„ä»¶
   */
  @Builder
  ArticleItem(article: Article) {
    Column() {
      Row() {
        Column() {
          Text(article.title)
            .fontSize(ThemeConstants.FONT_SIZE_BASE)
            .fontColor(ThemeConstants.TEXT_PRIMARY)
            .fontWeight(FontWeight.Medium)
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .lineHeight(22)

          if (article.desc) {
            Text(article.desc)
              .fontSize(ThemeConstants.FONT_SIZE_XS)
              .fontColor(ThemeConstants.TEXT_SECONDARY)
              .maxLines(2)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
              .margin({ top: ThemeConstants.SPACE_XS })
              .lineHeight(20)
          }

          Row() {
            Text(`ä½œè€…: ${article.author || article.shareUser || 'æœªçŸ¥'}`)
              .fontSize(ThemeConstants.FONT_SIZE_XXS)
              .fontColor(ThemeConstants.TEXT_TERTIARY)

            Blank()

            Text(article.niceDate)
              .fontSize(ThemeConstants.FONT_SIZE_XXS)
              .fontColor(ThemeConstants.TEXT_TERTIARY)
          }
          .width('100%')
          .margin({ top: ThemeConstants.SPACE_SM })
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Start)

        if (article.envelopePic) {
          Image(article.envelopePic)
            .width(80)
            .height(60)
            .objectFit(ImageFit.Cover)
            .borderRadius(ThemeConstants.BORDER_RADIUS_XS)
            .margin({ left: ThemeConstants.SPACE_SM })
            .onError(() => {
              console.error('Article image load failed:', article.envelopePic)
            })
            .alt('å›¾ç‰‡åŠ è½½å¤±è´¥')
        }
      }
      .width('100%')
      .alignItems(VerticalAlign.Top)

      Row() {
        if (article.fresh) {
          Text('æ–°')
            .fontSize(10)
            .fontColor(ThemeConstants.TEXT_WHITE)
            .backgroundColor(ThemeConstants.DANGER_COLOR)
            .padding({ left: 4, right: 4, top: 2, bottom: 2 })
            .borderRadius(2)
            .margin({ right: ThemeConstants.SPACE_XS })
        }

        Text(`${article.superChapterName} / ${article.chapterName}`)
          .fontSize(ThemeConstants.FONT_SIZE_XXS)
          .fontColor(ThemeConstants.PRIMARY_COLOR)
          .backgroundColor(ThemeConstants.PRIMARY_LIGHT_COLOR)
          .padding({ left: 8, right: 8, top: 4, bottom: 4 })
          .borderRadius(12)

        Blank()

        if (article.collect) {
          Text('â™¥')
            .fontSize(16)
            .fontColor(ThemeConstants.DANGER_COLOR)
        }
      }
      .width('100%')
      .margin({ top: ThemeConstants.SPACE_SM })
    }
    .width('100%')
    .padding(ThemeConstants.SPACE_MD)
    .backgroundColor(ThemeConstants.BG_WHITE)
    .borderRadius(ThemeConstants.BORDER_RADIUS_SM)
    .margin({ left: ThemeConstants.SPACE_MD, right: ThemeConstants.SPACE_MD, bottom: ThemeConstants.SPACE_XS })
  }
}
