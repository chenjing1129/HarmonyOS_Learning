import { formBindingData, FormExtensionAbility, formInfo, formProvider } from '@kit.FormKit';
import { Want } from '@kit.AbilityKit';
import { hilog } from '@kit.PerformanceAnalysisKit';
import { counterProvider } from '../providers/CounterProvider';

const TAG: string = 'CounterFormAbility';
const DOMAIN: number = 0x0005;

/**
 * è®¡æ•°å™¨å¡ç‰‡ FormExtensionAbility
 * è´Ÿè´£è®¡æ•°å™¨å¡ç‰‡çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†å’Œæ•°æ®æ›´æ–°
 */
export default class CounterFormAbility extends FormExtensionAbility {
  /**
   * å¡ç‰‡åˆ›å»ºæ—¶è§¦å‘
   */
  onAddForm(want: Want): formBindingData.FormBindingData {
    hilog.info(DOMAIN, TAG, 'ğŸ”¢ è®¡æ•°å™¨å¡ç‰‡åˆ›å»º');

    const formId: string = want.parameters?.['ohos.extra.param.key.form_identity'] as string;
    hilog.info(DOMAIN, TAG, `formId: ${formId}`);

    // åˆå§‹åŒ–è®¡æ•°å™¨æä¾›è€…ï¼ˆå¼‚æ­¥æ‰§è¡Œï¼Œä¸é˜»å¡å¡ç‰‡åˆ›å»ºï¼‰
    const applicationContext = this.context.getApplicationContext();
    counterProvider.initialize(applicationContext).then(() => {
      hilog.info(DOMAIN, TAG, 'è®¡æ•°å™¨æä¾›è€…åˆå§‹åŒ–æˆåŠŸ');
      // åˆå§‹åŒ–å®Œæˆåæ›´æ–°å¡ç‰‡
      this.onUpdateForm(formId);
    }).catch((error: Error) => {
      hilog.error(DOMAIN, TAG, `è®¡æ•°å™¨æä¾›è€…åˆå§‹åŒ–å¤±è´¥: ${error.message}`);
    });

    // è·å–å½“å‰è®¡æ•°å™¨æ•°æ®
    const counterData = counterProvider.getCounterDataObject();

    // è¿”å›å¡ç‰‡æ•°æ®
    const formData: Record<string, Object> = {
      'value': counterData.value,
      'lastUpdateTime': counterData.lastUpdateTime,
      'lastUpdateSource': counterData.lastUpdateSource,
      'lastUpdateTimeString': counterData.lastUpdateTimeString
    };

    hilog.info(DOMAIN, TAG, `ğŸ”¢ åˆå§‹è®¡æ•°å™¨å€¼: ${counterData.value}`);

    // è®¾ç½®å®šæ—¶å™¨ï¼Œæ¯30ç§’è‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡å¡ç‰‡
    setInterval(() => {
      this.onUpdateForm(formId);
    }, 30000);

    return formBindingData.createFormBindingData(formData);
  }

  /**
   * å¡ç‰‡æ›´æ–°æ—¶è§¦å‘
   */
  async onUpdateForm(formId: string): Promise<void> {
    hilog.info(DOMAIN, TAG, `ğŸ”„ è®¡æ•°å™¨å¡ç‰‡æ›´æ–°: ${formId}`);

    // è·å–æœ€æ–°è®¡æ•°å™¨æ•°æ®
    const counterData = counterProvider.getCounterDataObject();

    const formData: Record<string, Object> = {
      'value': counterData.value,
      'lastUpdateTime': counterData.lastUpdateTime,
      'lastUpdateSource': counterData.lastUpdateSource,
      'lastUpdateTimeString': counterData.lastUpdateTimeString
    };

    hilog.info(DOMAIN, TAG, `ğŸ”¢ æ›´æ–°è®¡æ•°å™¨å€¼: ${counterData.value}`);

    // æ›´æ–°å¡ç‰‡æ•°æ®
    const formBindData: formBindingData.FormBindingData = formBindingData.createFormBindingData(formData);

    // é€šçŸ¥å¡ç‰‡åˆ·æ–°
    formProvider.updateForm(formId, formBindData).then(() => {
      hilog.info(DOMAIN, TAG, `âœ… è®¡æ•°å™¨å¡ç‰‡æ›´æ–°æˆåŠŸ`);
    }).catch((error: Error) => {
      hilog.error(DOMAIN, TAG, `âŒ è®¡æ•°å™¨å¡ç‰‡æ›´æ–°å¤±è´¥: ${error.message}`);
    });
  }

  /**
   * å¡ç‰‡åˆ é™¤æ—¶è§¦å‘
   */
  onRemoveForm(formId: string): void {
    hilog.info(DOMAIN, TAG, `ğŸ—‘ï¸ è®¡æ•°å™¨å¡ç‰‡åˆ é™¤: ${formId}`);
  }

  /**
   * å¡ç‰‡äº‹ä»¶å¤„ç†
   */
  async onFormEvent(formId: string, message: string): Promise<void> {
    hilog.info(DOMAIN, TAG, `ğŸ”” æ”¶åˆ°äº‹ä»¶ - formId: ${formId}, message: ${message}`);

    // åˆå§‹åŒ–è®¡æ•°å™¨æä¾›è€…
    try {
      // ä½¿ç”¨this.context.getApplicationContext()è·å–åº”ç”¨ä¸Šä¸‹æ–‡
      const applicationContext = this.context.getApplicationContext();
      await counterProvider.initialize(applicationContext);
    } catch (error) {
      hilog.error(DOMAIN, TAG, `è®¡æ•°å™¨æä¾›è€…åˆå§‹åŒ–å¤±è´¥: ${error.message}`);
      return;
    }

    // è§£ææ¶ˆæ¯ï¼ˆå¯èƒ½æ˜¯JSONå­—ç¬¦ä¸²ï¼‰
    let eventMessage = message;
    try {
      const messageObj = JSON.parse(message) as Record<string, string>;
      if (messageObj.message) {
        eventMessage = messageObj.message;
      }
    } catch (e) {
      // å¦‚æœè§£æå¤±è´¥ï¼Œç›´æ¥ä½¿ç”¨åŸå§‹æ¶ˆæ¯
      eventMessage = message;
    }

    hilog.info(DOMAIN, TAG, `ğŸ”” è§£æåçš„äº‹ä»¶æ¶ˆæ¯: ${eventMessage}`);

    // å¤„ç†ä¸åŒçš„äº‹ä»¶
    if (eventMessage === 'increment') {
      hilog.info(DOMAIN, TAG, 'â• å¢åŠ è®¡æ•°å™¨å€¼');
      await counterProvider.incrementCounter(1, 'card');
      await this.onUpdateForm(formId);
    } else if (eventMessage === 'decrement') {
      hilog.info(DOMAIN, TAG, 'â– å‡å°‘è®¡æ•°å™¨å€¼');
      await counterProvider.decrementCounter(1, 'card');
      await this.onUpdateForm(formId);
    } else if (eventMessage === 'reset') {
      hilog.info(DOMAIN, TAG, 'ğŸ”„ é‡ç½®è®¡æ•°å™¨å€¼');
      await counterProvider.resetCounter('card');
      await this.onUpdateForm(formId);
    } else if (eventMessage === 'refresh') {
      hilog.info(DOMAIN, TAG, 'ğŸ”„ åˆ·æ–°è®¡æ•°å™¨å€¼');
      await this.onUpdateForm(formId);
    }
  }

  /**
   * è·å–å¡ç‰‡çŠ¶æ€
   */
  onAcquireFormState(want: Want): formInfo.FormState {
    hilog.info(DOMAIN, TAG, 'è·å–è®¡æ•°å™¨å¡ç‰‡çŠ¶æ€');
    return formInfo.FormState.READY;
  }
}