import { formBindingData, formInfo, formProvider } from '@kit.FormKit';
import { FormExtensionAbility } from '@kit.FormKit';
import type { Want } from '@kit.AbilityKit';
import { hilog } from '@kit.PerformanceAnalysisKit';
import { weatherProvider } from '../providers/WeatherProvider';

const TAG: string = 'WeatherFormAbility';
const DOMAIN: number = 0x0001;

/**
 * å¤©æ°”å¡ç‰‡ FormExtensionAbility
 * è´Ÿè´£å¡ç‰‡çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†å’Œæ•°æ®æ›´æ–°
 */
export default class WeatherFormAbility extends FormExtensionAbility {
  private updateTimer: number = -1;

  /**
   * å¡ç‰‡åˆ›å»ºæ—¶è§¦å‘
   */
  onAddForm(want: Want): formBindingData.FormBindingData {
    hilog.info(DOMAIN, TAG, 'ğŸŒ¤ï¸ å¤©æ°”å¡ç‰‡åˆ›å»º');

    const formId: string = want.parameters?.['ohos.extra.param.key.form_identity'] as string;
    hilog.info(DOMAIN, TAG, `formId: ${formId}`);

    // è·å–éšæœºå¤©æ°”æ•°æ®
    const weatherData = weatherProvider.getRandomWeather();

    // è®¡ç®—æ›´æ–°æ—¶é—´
    const lastUpdate = this.formatUpdateTime(weatherData.timestamp);

    // è¿”å›å¡ç‰‡æ•°æ®
    const formData: Record<string, Object> = {
      'city': weatherData.city,
      'temperature': weatherData.temperature,
      'weather': weatherData.weather,
      'weatherCode': weatherData.weatherCode,
      'humidity': weatherData.humidity,
      'windSpeed': weatherData.windSpeed,
      'timestamp': weatherData.timestamp,
      'lastUpdate': lastUpdate
    };

    hilog.info(DOMAIN, TAG, `ğŸŒ¤ï¸ åˆå§‹å¤©æ°”: ${weatherData.city} ${weatherData.temperature}Â°C ${weatherData.weather}`);

    // å¯åŠ¨å®šæ—¶æ›´æ–°
    this.startPeriodicUpdate(formId);

    return formBindingData.createFormBindingData(formData);
  }

  /**
   * å¡ç‰‡æ›´æ–°æ—¶è§¦å‘
   */
  onUpdateForm(formId: string): void {
    hilog.info(DOMAIN, TAG, `ğŸ”„ å¤©æ°”å¡ç‰‡æ›´æ–°: ${formId}`);

    // è·å–æœ€æ–°å¤©æ°”æ•°æ®
    const weatherData = weatherProvider.getRandomWeather();

    // è®¡ç®—æ›´æ–°æ—¶é—´
    const lastUpdate = this.formatUpdateTime(weatherData.timestamp);

    const formData: Record<string, Object> = {
      'city': weatherData.city,
      'temperature': weatherData.temperature,
      'weather': weatherData.weather,
      'weatherCode': weatherData.weatherCode,
      'humidity': weatherData.humidity,
      'windSpeed': weatherData.windSpeed,
      'timestamp': weatherData.timestamp,
      'lastUpdate': lastUpdate
    };

    hilog.info(DOMAIN, TAG, `ğŸŒ¤ï¸ æ›´æ–°å¤©æ°”: ${weatherData.city} ${weatherData.temperature}Â°C ${weatherData.weather}`);

    // æ›´æ–°å¡ç‰‡æ•°æ®
    const formBindData: formBindingData.FormBindingData = formBindingData.createFormBindingData(formData);

    // é€šçŸ¥å¡ç‰‡åˆ·æ–°
    formProvider.updateForm(formId, formBindData).then(() => {
      hilog.info(DOMAIN, TAG, `âœ… å¤©æ°”å¡ç‰‡æ›´æ–°æˆåŠŸ`);
    }).catch((error: Error) => {
      hilog.error(DOMAIN, TAG, `âŒ å¤©æ°”å¡ç‰‡æ›´æ–°å¤±è´¥: ${error.message}`);
    });
  }

  /**
   * å¡ç‰‡åˆ é™¤æ—¶è§¦å‘
   */
  onRemoveForm(formId: string): void {
    hilog.info(DOMAIN, TAG, `ğŸ—‘ï¸ å¤©æ°”å¡ç‰‡åˆ é™¤: ${formId}`);
    
    // åœæ­¢å®šæ—¶æ›´æ–°
    this.stopPeriodicUpdate();
  }

  /**
   * å¡ç‰‡äº‹ä»¶å¤„ç†
   */
  onFormEvent(formId: string, message: string): void {
    hilog.info(DOMAIN, TAG, `ğŸ”” æ”¶åˆ°äº‹ä»¶ - formId: ${formId}, message: ${message}`);

    // å¤„ç†åˆ·æ–°äº‹ä»¶
    if (message === 'refresh') {
      hilog.info(DOMAIN, TAG, 'ğŸ”„ å¼€å§‹åˆ·æ–°å¤©æ°”...');
      this.onUpdateForm(formId);
    }
  }

  /**
   * è·å–å¡ç‰‡çŠ¶æ€
   */
  onAcquireFormState(want: Want): formInfo.FormState {
    hilog.info(DOMAIN, TAG, 'è·å–å¤©æ°”å¡ç‰‡çŠ¶æ€');
    return formInfo.FormState.READY;
  }

  /**
   * å¯åŠ¨å®šæ—¶æ›´æ–°
   */
  private startPeriodicUpdate(formId: string): void {
    // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
    this.stopPeriodicUpdate();
    
    // æ¯5ç§’æ›´æ–°ä¸€æ¬¡
    this.updateTimer = setInterval(() => {
      hilog.info(DOMAIN, TAG, 'â° å®šæ—¶æ›´æ–°å¤©æ°”å¡ç‰‡');
      this.onUpdateForm(formId);
    }, 5000);
    
    hilog.info(DOMAIN, TAG, 'âœ… å·²å¯åŠ¨å®šæ—¶æ›´æ–°ï¼Œé—´éš”5ç§’');
  }

  /**
   * åœæ­¢å®šæ—¶æ›´æ–°
   */
  private stopPeriodicUpdate(): void {
    if (this.updateTimer !== -1) {
      clearInterval(this.updateTimer);
      this.updateTimer = -1;
      hilog.info(DOMAIN, TAG, 'â¹ï¸ å·²åœæ­¢å®šæ—¶æ›´æ–°');
    }
  }

  /**
   * æ ¼å¼åŒ–æ›´æ–°æ—¶é—´
   */
  private formatUpdateTime(timestamp: number): string {
    const now = Date.now();
    const diff = now - timestamp;
    
    if (diff < 60000) { // å°äº1åˆ†é’Ÿ
      return 'åˆšåˆšæ›´æ–°';
    } else if (diff < 3600000) { // å°äº1å°æ—¶
      const minutes = Math.floor(diff / 60000);
      return `${minutes}åˆ†é’Ÿå‰æ›´æ–°`;
    } else {
      const date = new Date(timestamp);
      const hours = date.getHours().toString().padStart(2, '0');
      const minutes = date.getMinutes().toString().padStart(2, '0');
      return `ä»Šå¤© ${hours}:${minutes} æ›´æ–°`;
    }
  }
}