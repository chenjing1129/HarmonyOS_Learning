import { formBindingData, formInfo, formProvider } from '@kit.FormKit';
import { FormExtensionAbility } from '@kit.FormKit';
import type { Want } from '@kit.AbilityKit';
import { hilog } from '@kit.PerformanceAnalysisKit';
import { timeProvider } from '../providers/TimeProvider';

const TAG: string = 'ClockFormAbility';
const DOMAIN: number = 0x0001;

/**
 * æ—¶é’Ÿå¡ç‰‡ FormExtensionAbility
 * è´Ÿè´£å¡ç‰‡çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†å’Œæ•°æ®æ›´æ–°
 */
export default class ClockFormAbility extends FormExtensionAbility {
  /**
   * å¡ç‰‡åˆ›å»ºæ—¶è§¦å‘
   */
  onAddForm(want: Want): formBindingData.FormBindingData {
    hilog.info(DOMAIN, TAG, 'â° æ—¶é’Ÿå¡ç‰‡åˆ›å»º');

    const formId: string = want.parameters?.['ohos.extra.param.key.form_identity'] as string;
    hilog.info(DOMAIN, TAG, `formId: ${formId}`);

    // è·å–å½“å‰æ—¶é—´
    const timeData = timeProvider.getCurrentTime();

    // è¿”å›å¡ç‰‡æ•°æ®
    const formData: Record<string, Object> = {
      'year': timeData.year,
      'month': timeData.month,
      'day': timeData.day,
      'weekday': timeData.weekday,
      'hour': timeData.hour,
      'minute': timeData.minute,
      'second': timeData.second,
      'timestamp': timeData.timestamp
    };

    hilog.info(DOMAIN, TAG, `ğŸ“… åˆå§‹æ—¶é—´: ${timeData.year}-${timeData.month}-${timeData.day} ${timeData.hour}:${timeData.minute}:${timeData.second}`);

    return formBindingData.createFormBindingData(formData);
  }

  /**
   * å¡ç‰‡æ›´æ–°æ—¶è§¦å‘
   */
  onUpdateForm(formId: string): void {
    hilog.info(DOMAIN, TAG, `ğŸ”„ å¡ç‰‡æ›´æ–°: ${formId}`);

    // è·å–æœ€æ–°æ—¶é—´
    const timeData = timeProvider.getCurrentTime();

    const formData: Record<string, Object> = {
      'year': timeData.year,
      'month': timeData.month,
      'day': timeData.day,
      'weekday': timeData.weekday,
      'hour': timeData.hour,
      'minute': timeData.minute,
      'second': timeData.second,
      'timestamp': timeData.timestamp
    };

    hilog.info(DOMAIN, TAG, `â° æ›´æ–°æ—¶é—´: ${timeData.hour}:${timeData.minute}:${timeData.second}`);

    // æ›´æ–°å¡ç‰‡æ•°æ®
    const formBindData: formBindingData.FormBindingData = formBindingData.createFormBindingData(formData);

    // é€šçŸ¥å¡ç‰‡åˆ·æ–°
    formProvider.updateForm(formId, formBindData).then(() => {
      hilog.info(DOMAIN, TAG, `âœ… å¡ç‰‡æ›´æ–°æˆåŠŸ`);
    }).catch((error: Error) => {
      hilog.error(DOMAIN, TAG, `âŒ å¡ç‰‡æ›´æ–°å¤±è´¥: ${error.message}`);
    });
  }

  /**
   * å¡ç‰‡åˆ é™¤æ—¶è§¦å‘
   */
  onRemoveForm(formId: string): void {
    hilog.info(DOMAIN, TAG, `ğŸ—‘ï¸ å¡ç‰‡åˆ é™¤: ${formId}`);
  }

  /**
   * å¡ç‰‡äº‹ä»¶å¤„ç†
   */
  onFormEvent(formId: string, message: string): void {
    hilog.info(DOMAIN, TAG, `ğŸ”” æ”¶åˆ°äº‹ä»¶ - formId: ${formId}, message: ${message}`);

    // å¤„ç†åˆ·æ–°äº‹ä»¶
    if (message === 'refresh') {
      hilog.info(DOMAIN, TAG, 'ğŸ”„ å¼€å§‹åˆ·æ–°æ—¶é—´...');
      this.onUpdateForm(formId);
    }
  }

  /**
   * è·å–å¡ç‰‡çŠ¶æ€
   */
  onAcquireFormState(want: Want): formInfo.FormState {
    hilog.info(DOMAIN, TAG, 'è·å–å¡ç‰‡çŠ¶æ€');
    return formInfo.FormState.READY;
  }
}
