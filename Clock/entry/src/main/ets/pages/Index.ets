import { hilog } from '@kit.PerformanceAnalysisKit';
import { timeProvider } from '../providers/TimeProvider';
import type { TimeData } from '../providers/TimeProvider';
import { weatherProvider } from '../providers/WeatherProvider';
import type { WeatherData } from '../providers/WeatherProvider';
import { counterProvider } from '../providers/CounterProvider';
import type { CounterData } from '../providers/CounterProvider';

// å®šä¹‰SelectOptionç±»åž‹
interface SelectOption {
  value: string;
  icon?: string;
  selectedIcon?: Resource;
}

const TAG: string = 'Index';
const DOMAIN: number = 0x0001;

/**
 * æ—¶é’Ÿå¤©æ°”å¡ç‰‡åº”ç”¨ä¸»é¡µé¢
 */
@Entry
@Component
struct Index {
  @State currentTime: TimeData | null = null;
  @State currentWeather: WeatherData | null = null;
  @State counterData: CounterData | null = null;
  @State selectedCity: string = 'åŒ—äº¬';
  @State cities: string[] = [];
  @State activeTab: number = 0; // 0: æ—¶é’Ÿ, 1: å¤©æ°”, 2: è®¡æ•°å™¨
  private timer: number = -1; // å®šæ—¶å™¨ID

  aboutToAppear(): void {
    hilog.info(DOMAIN, TAG, 'aboutToAppear');
    this.cities = weatherProvider.getCities();
    
    // åˆå§‹åŒ–è®¡æ•°å™¨æä¾›è€…
    try {
      const context = this.getUIContext().getHostContext();
      if (context) {
        counterProvider.initialize(context).then(() => {
          hilog.info(DOMAIN, TAG, 'è®¡æ•°å™¨æä¾›è€…åˆå§‹åŒ–å®Œæˆ');
          this.updateTime();
          this.updateWeather();
          this.updateCounter();
          
          // è®¾ç½®å®šæ—¶å™¨ï¼Œæ¯5ç§’æ›´æ–°ä¸€æ¬¡
          this.timer = setInterval(() => {
            this.updateTime();
            this.updateWeather();
            this.updateCounter();
            hilog.info(DOMAIN, TAG, 'å®šæ—¶å™¨è§¦å‘: æ—¶é—´ã€å¤©æ°”å’Œè®¡æ•°å™¨å·²æ›´æ–°');
          }, 5000);
        }).catch((error: Error) => {
          hilog.error(DOMAIN, TAG, `è®¡æ•°å™¨æä¾›è€…åˆå§‹åŒ–å¤±è´¥: ${error.message}`);
          // å³ä½¿åˆå§‹åŒ–å¤±è´¥ï¼Œä¹Ÿè¦æ›´æ–°æ—¶é—´å’Œå¤©æ°”
          this.updateTime();
          this.updateWeather();
          
          // è®¾ç½®å®šæ—¶å™¨ï¼Œæ¯5ç§’æ›´æ–°ä¸€æ¬¡
          this.timer = setInterval(() => {
            this.updateTime();
            this.updateWeather();
            hilog.info(DOMAIN, TAG, 'å®šæ—¶å™¨è§¦å‘: æ—¶é—´å’Œå¤©æ°”å·²æ›´æ–°');
          }, 5000);
        });
      } else {
        hilog.error(DOMAIN, TAG, 'æ— æ³•èŽ·å–ä¸Šä¸‹æ–‡');
        // å³ä½¿èŽ·å–ä¸Šä¸‹æ–‡å¤±è´¥ï¼Œä¹Ÿè¦æ›´æ–°æ—¶é—´å’Œå¤©æ°”
        this.updateTime();
        this.updateWeather();
        
        // è®¾ç½®å®šæ—¶å™¨ï¼Œæ¯5ç§’æ›´æ–°ä¸€æ¬¡
        this.timer = setInterval(() => {
          this.updateTime();
          this.updateWeather();
          hilog.info(DOMAIN, TAG, 'å®šæ—¶å™¨è§¦å‘: æ—¶é—´å’Œå¤©æ°”å·²æ›´æ–°');
        }, 5000);
      }
    } catch (error) {
      hilog.error(DOMAIN, TAG, `èŽ·å–ä¸Šä¸‹æ–‡å¼‚å¸¸: ${error}`);
      // å³ä½¿èŽ·å–ä¸Šä¸‹æ–‡å¤±è´¥ï¼Œä¹Ÿè¦æ›´æ–°æ—¶é—´å’Œå¤©æ°”
      this.updateTime();
      this.updateWeather();
      
      // è®¾ç½®å®šæ—¶å™¨ï¼Œæ¯5ç§’æ›´æ–°ä¸€æ¬¡
      this.timer = setInterval(() => {
        this.updateTime();
        this.updateWeather();
        hilog.info(DOMAIN, TAG, 'å®šæ—¶å™¨è§¦å‘: æ—¶é—´å’Œå¤©æ°”å·²æ›´æ–°');
      }, 5000);
    }
  }

  aboutToDisappear(): void {
    // æ¸…é™¤å®šæ—¶å™¨
    if (this.timer !== -1) {
      clearInterval(this.timer);
      this.timer = -1;
      hilog.info(DOMAIN, TAG, 'å®šæ—¶å™¨å·²æ¸…é™¤');
    }
  }

  /**
   * æ›´æ–°æ—¶é—´
   */
  updateTime(): void {
    this.currentTime = timeProvider.getCurrentTime();
    hilog.info(DOMAIN, TAG, `æ—¶é—´æ›´æ–°: ${this.currentTime.hour}:${this.currentTime.minute}:${this.currentTime.second}`);
  }

  /**
   * æ›´æ–°å¤©æ°”
   */
  updateWeather(): void {
    this.currentWeather = weatherProvider.getWeatherByCity(this.selectedCity);
    hilog.info(DOMAIN, TAG,
      `å¤©æ°”æ›´æ–°: ${this.currentWeather.city} ${this.currentWeather.temperature}Â°C ${this.currentWeather.weather}`);
  }

  /**
   * æ›´æ–°è®¡æ•°å™¨
   */
  updateCounter(): void {
    this.counterData = counterProvider.getCounterData();
    hilog.info(DOMAIN, TAG, `è®¡æ•°å™¨æ›´æ–°: ${this.counterData.value}, æ¥æº: ${this.counterData.lastUpdateSource}`);
  }

  /**
   * åˆ·æ–°è®¡æ•°å™¨æ•°æ®
   */
  refreshCounter(): void {
    this.updateCounter();
    // è§¦å‘UIæ›´æ–°
    if (this.activeTab === 2) {
      // å¦‚æžœå½“å‰åœ¨è®¡æ•°å™¨æ ‡ç­¾é¡µï¼Œå¼ºåˆ¶åˆ·æ–°UI
      this.activeTab = 1;
      setTimeout(() => {
        this.activeTab = 2;
      }, 100);
    }
  }

  build() {
    Column({ space: 20 }) {
      // æ ‡é¢˜
      Row() {
        Text('æ—¶é’Ÿå¤©æ°”å¡ç‰‡ç¤ºä¾‹')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .fontColor($r('app.color.text_primary'))

        Blank()

        Button('åˆ·æ–°')
          .fontSize(14)
          .height(32)
          .onClick(() => {
            hilog.info(DOMAIN, TAG, `ç”¨æˆ·ç‚¹å‡»åˆ·æ–°æŒ‰é’®ï¼Œå½“å‰æ ‡ç­¾é¡µ: ${this.activeTab === 0 ? 'æ—¶é’Ÿ' : this.activeTab === 1 ? 'å¤©æ°”' : 'è®¡æ•°å™¨'}`);
            if (this.activeTab === 0) {
              this.updateTime();
            } else if (this.activeTab === 1) {
              this.updateWeather();
            } else {
              this.updateCounter();
            }
          })
      }
      .width('90%')
      .padding({ top: 20 })

      // é€‰é¡¹å¡
      Tabs({ barPosition: BarPosition.Start }) {
        TabContent() {
          this.clockTabContent()
        }
        .tabBar('æ—¶é’Ÿå¡ç‰‡')
        .backgroundColor($r('app.color.page_background'))

        TabContent() {
          this.weatherTabContent()
        }
        .tabBar('å¤©æ°”å¡ç‰‡')
        .backgroundColor($r('app.color.page_background'))

        TabContent() {
          this.counterTabContent()
        }
        .tabBar('è®¡æ•°å™¨å¡ç‰‡')
        .backgroundColor($r('app.color.page_background'))
      }
      .barHeight(48)
      .animationDuration(300)
      .onChange((index: number) => {
        hilog.info(DOMAIN, TAG, `æ ‡ç­¾é¡µåˆ‡æ¢: ä»Ž ${this.activeTab === 0 ? 'æ—¶é’Ÿ' : this.activeTab === 1 ? 'å¤©æ°”' : 'è®¡æ•°å™¨'} åˆ‡æ¢åˆ° ${index === 0 ? 'æ—¶é’Ÿ' : index === 1 ? 'å¤©æ°”' : 'è®¡æ•°å™¨'}`);
        this.activeTab = index;
      })
      .width('90%')
      .layoutWeight(1)
      .width('90%')
      .padding(16)
      .backgroundColor($r('app.color.card_background'))
      .borderRadius(12)
      .shadow({
        radius: 8,
        color: $r('app.color.shadow'),
        offsetX: 0,
        offsetY: 2
      })
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.page_background'))
  }

  @Builder
  clockTabContent() {
    Column({ space: 20 }) {
      // å½“å‰æ—¶é—´æ˜¾ç¤º
      if (this.currentTime) {
        Column({ space: 15 }) {
          Text('å½“å‰æ—¶é—´')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor($r('app.color.text_primary'))
            .width('100%')

          // æ—¥æœŸ
          Text(`${this.currentTime.year}-${this.currentTime.month}-${this.currentTime.day}`)
            .fontSize(18)
            .fontColor($r('app.color.text_primary'))

          Text(this.currentTime.weekday)
            .fontSize(16)
            .fontColor($r('app.color.text_secondary'))

          // æ—¶é—´ï¼ˆå¤§å­—ä½“ï¼Œè‡ªé€‚åº”å±å¹•ï¼‰
          Row({ space: 4 }) {
            Text(this.currentTime.hour)
              .fontSize(60)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.primary_blue'))
              .maxFontSize(72)
              .minFontSize(36)

            Text(':')
              .fontSize(60)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.primary_blue'))
              .maxFontSize(72)
              .minFontSize(36)

            Text(this.currentTime.minute)
              .fontSize(60)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.primary_blue'))
              .maxFontSize(72)
              .minFontSize(36)

            Text(':')
              .fontSize(60)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.primary_blue'))
              .maxFontSize(72)
              .minFontSize(36)

            Text(this.currentTime.second)
              .fontSize(60)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.primary_blue'))
              .maxFontSize(72)
              .minFontSize(36)
          }
          .justifyContent(FlexAlign.Center)
          .width('100%')
          .constraintSize({ maxWidth: '100%' })

          // æ—¶é—´æˆ³ï¼ˆè‡ªé€‚åº”å±å¹•ï¼‰
          Text(`æ—¶é—´æˆ³: ${this.currentTime.timestamp}`)
            .fontSize(12)
            .fontColor($r('app.color.text_tertiary'))
            .maxFontSize(14)
            .minFontSize(10)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .maxLines(1)
        }
        .width('90%')
        .padding(20)
        .backgroundColor($r('app.color.card_background'))
        .borderRadius(16)
        .shadow({
          radius: 12,
          color: $r('app.color.shadow'),
          offsetX: 0,
          offsetY: 4
        })
      }
    }
  }

  @Builder
  weatherTabContent() {
    Column({ space: 20 }) {
      // åŸŽå¸‚é€‰æ‹©
      Row() {
        Text('é€‰æ‹©åŸŽå¸‚:')
          .fontSize(16)
          .fontColor($r('app.color.text_primary'))

        Blank()

        Select(this.cities.map((city: string): SelectOption => {
          return { value: city };
        }))
          .selected(0)
          .value(this.selectedCity)
          .font({ size: 16 })
          .onSelect((index: number, value: string) => {
            hilog.info(DOMAIN, TAG, `åŸŽå¸‚é€‰æ‹©: ä»Ž ${this.selectedCity} åˆ‡æ¢åˆ° ${value}`);
            this.selectedCity = value;
            this.updateWeather();
            hilog.info(DOMAIN, TAG, `å·²åŠ è½½ ${value} çš„å¤©æ°”æ•°æ®`);
          })
      }
      .width('90%')
      .padding(16)
      .backgroundColor($r('app.color.card_background'))
      .borderRadius(12)
      .shadow({
        radius: 8,
        color: $r('app.color.shadow'),
        offsetX: 0,
        offsetY: 2
      })

      // å½“å‰å¤©æ°”æ˜¾ç¤º
      if (this.currentWeather) {
        Column({ space: 15 }) {
          Text('å½“å‰å¤©æ°”')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor($r('app.color.text_primary'))
            .width('100%')

          // åŸŽå¸‚å’Œå¤©æ°”
          Row({ space: 16 }) {
            Column() {
              Text(this.currentWeather.city)
                .fontSize(20)
                .fontWeight(FontWeight.Bold)
                .fontColor($r('app.color.text_primary'))

              Text(this.currentWeather.weather)
                .fontSize(16)
                .fontColor($r('app.color.text_secondary'))
            }
            .alignItems(HorizontalAlign.Start)
            .layoutWeight(1)

            Text(weatherProvider.getWeatherIcon(this.currentWeather.weatherCode))
              .fontSize(48)
          }
          .width('100%')
          .alignItems(VerticalAlign.Center)

          // æ¸©åº¦
          Text(`${this.currentWeather.temperature}Â°C`)
            .fontSize(48)
            .fontWeight(FontWeight.Bold)
            .fontColor($r('app.color.primary_blue'))
            .width('100%')
            .textAlign(TextAlign.Center)

          // è¯¦ç»†ä¿¡æ¯
          Row({ space: 24 }) {
            // æ¹¿åº¦
            Column({ space: 4 }) {
              Text('ðŸ’§')
                .fontSize(18)
              Text(`${this.currentWeather.humidity}%`)
                .fontSize(14)
                .fontColor($r('app.color.text_secondary'))
              Text('æ¹¿åº¦')
                .fontSize(12)
                .fontColor($r('app.color.text_tertiary'))
            }
            .alignItems(HorizontalAlign.Center)

            // é£Žé€Ÿ
            Column({ space: 4 }) {
              Text('ðŸ’¨')
                .fontSize(18)
              Text(`${this.currentWeather.windSpeed}km/h`)
                .fontSize(14)
                .fontColor($r('app.color.text_secondary'))
              Text('é£Žé€Ÿ')
                .fontSize(12)
                .fontColor($r('app.color.text_tertiary'))
            }
            .alignItems(HorizontalAlign.Center)

            Blank()

            // æ—¶é—´æˆ³ï¼ˆè‡ªé€‚åº”å±å¹•ï¼‰
            Text(`æ›´æ–°æ—¶é—´: ${new Date(this.currentWeather.timestamp).toLocaleTimeString()}`)
              .fontSize(12)
              .fontColor($r('app.color.text_tertiary'))
              .maxFontSize(14)
              .minFontSize(10)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
              .maxLines(1)
          }
          .width('100%')
          .padding({ top: 8 })
        }
        .width('90%')
        .padding(20)
        .backgroundColor($r('app.color.card_background'))
        .borderRadius(16)
        .shadow({
          radius: 12,
          color: $r('app.color.shadow'),
          offsetX: 0,
          offsetY: 4
        })
        .width('90%')
        .padding(16)
        .backgroundColor($r('app.color.card_background'))
        .borderRadius(12)
        .shadow({
          radius: 8,
          color: $r('app.color.shadow'),
          offsetX: 0,
          offsetY: 2
        })
      }
    }
  }

  @Builder
  counterTabContent() {
    Column({ space: 20 }) {
      // å½“å‰è®¡æ•°å™¨æ˜¾ç¤º
      if (this.counterData) {
        Column({ space: 15 }) {
          Text('è®¡æ•°å™¨')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor($r('app.color.text_primary'))
            .width('100%')

          // è®¡æ•°å™¨å€¼ï¼ˆå¤§å­—ä½“ï¼Œè‡ªé€‚åº”å±å¹•ï¼‰
          Text(`${this.counterData.value}`)
            .fontSize(72)
            .fontWeight(FontWeight.Bold)
            .fontColor($r('app.color.primary_blue'))
            .maxFontSize(96)
            .minFontSize(48)
            .width('100%')
            .textAlign(TextAlign.Center)

          // æ“ä½œæŒ‰é’®
            Row({ space: 16 }) {
              Button({ type: ButtonType.Circle }) {
                Text('-')
                  .fontSize(24)
                  .fontColor(Color.White)
                  .fontWeight(FontWeight.Bold)
              }
                .width(64)
                .height(64)
                .backgroundColor($r('app.color.button_background'))
                .onClick(() => {
                  hilog.info(DOMAIN, TAG, 'ç”¨æˆ·ç‚¹å‡»å‡å°‘æŒ‰é’®');
                  counterProvider.decrementCounter(1, 'page').then((success) => {
                    if (success) {
                      this.refreshCounter();
                    }
                  });
                })
              
              Button({ type: ButtonType.Circle }) {
                Text('â†»')
                  .fontSize(24)
                  .fontColor(Color.White)
                  .fontWeight(FontWeight.Bold)
              }
                .width(64)
                .height(64)
                .backgroundColor($r('app.color.button_background'))
                .onClick(() => {
                  hilog.info(DOMAIN, TAG, 'ç”¨æˆ·ç‚¹å‡»é‡ç½®æŒ‰é’®');
                  counterProvider.resetCounter('page').then((success) => {
                    if (success) {
                      this.refreshCounter();
                    }
                  });
                })
              
              Button({ type: ButtonType.Circle }) {
                Text('+')
                  .fontSize(24)
                  .fontColor(Color.White)
                  .fontWeight(FontWeight.Bold)
              }
                .width(64)
                .height(64)
                .backgroundColor($r('app.color.button_background'))
                .onClick(() => {
                  hilog.info(DOMAIN, TAG, 'ç”¨æˆ·ç‚¹å‡»å¢žåŠ æŒ‰é’®');
                  counterProvider.incrementCounter(1, 'page').then((success) => {
                    if (success) {
                      this.refreshCounter();
                    }
                  });
                })
            }
          .width('100%')
          .justifyContent(FlexAlign.SpaceEvenly)
          .width('100%')
          .padding({ top: 16 })
        }
        .width('90%')
        .padding(20)
        .backgroundColor($r('app.color.card_background'))
        .borderRadius(16)
        .shadow({
          radius: 12,
          color: $r('app.color.shadow'),
          offsetX: 0,
          offsetY: 4
        })
      }
    }
  }
}
