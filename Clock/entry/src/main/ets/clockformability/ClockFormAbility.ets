import { formBindingData, FormExtensionAbility, formInfo, formProvider } from '@kit.FormKit';
import { Want } from '@kit.AbilityKit';
import { hilog } from '@kit.PerformanceAnalysisKit';
import { timeProvider } from '../providers/TimeProvider';

const TAG: string = 'ClockFormAbility';
const DOMAIN: number = 0x0002;

/**
 * æ—¶é’Ÿå¡ç‰‡ FormExtensionAbility
 * è´Ÿè´£å¡ç‰‡çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†å’Œæ•°æ®æ›´æ–°
 */
export default class ClockFormAbility extends FormExtensionAbility {
  private updateTimer: number = -1;

  /**
   * å¡ç‰‡åˆ›å»ºæ—¶è§¦å‘
   */
  onAddForm(want: Want): formBindingData.FormBindingData {
    hilog.info(DOMAIN, TAG, 'â° æ—¶é’Ÿå¡ç‰‡åˆ›å»º');

    const formId: string = want.parameters?.['ohos.extra.param.key.form_identity'] as string;
    hilog.info(DOMAIN, TAG, `formId: ${formId}`);

    // è·å–å½“å‰æ—¶é—´æ•°æ®
    const timeData = timeProvider.getCurrentTime();

    // è¿”å›å¡ç‰‡æ•°æ®
    const formData: Record<string, Object> = {
      'year': timeData.year,
      'month': timeData.month,
      'day': timeData.day,
      'weekday': timeData.weekday,
      'hour': timeData.hour,
      'minute': timeData.minute,
      'second': timeData.second,
      'timestamp': timeData.timestamp
    };

    hilog.info(DOMAIN, TAG, `â° åˆå§‹æ—¶é—´: ${timeData.year}-${timeData.month}-${timeData.day} ${timeData.hour}:${timeData.minute}:${timeData.second}`);

    // å¯åŠ¨å®šæ—¶æ›´æ–°
    this.startPeriodicUpdate(formId);

    return formBindingData.createFormBindingData(formData);
  }

  /**
   * å¡ç‰‡æ›´æ–°æ—¶è§¦å‘
   */
  onUpdateForm(formId: string): void {
    hilog.info(DOMAIN, TAG, `ğŸ”„ æ—¶é’Ÿå¡ç‰‡æ›´æ–°: ${formId}`);

    // è·å–æœ€æ–°æ—¶é—´æ•°æ®
    const timeData = timeProvider.getCurrentTime();

    const formData: Record<string, Object> = {
      'year': timeData.year,
      'month': timeData.month,
      'day': timeData.day,
      'weekday': timeData.weekday,
      'hour': timeData.hour,
      'minute': timeData.minute,
      'second': timeData.second,
      'timestamp': timeData.timestamp
    };

    hilog.info(DOMAIN, TAG, `â° æ›´æ–°æ—¶é—´: ${timeData.year}-${timeData.month}-${timeData.day} ${timeData.hour}:${timeData.minute}:${timeData.second}`);

    // æ›´æ–°å¡ç‰‡æ•°æ®
    const formBindData: formBindingData.FormBindingData = formBindingData.createFormBindingData(formData);

    // é€šçŸ¥å¡ç‰‡åˆ·æ–°
    formProvider.updateForm(formId, formBindData).then(() => {
      hilog.info(DOMAIN, TAG, `âœ… æ—¶é’Ÿå¡ç‰‡æ›´æ–°æˆåŠŸ`);
    }).catch((error: Error) => {
      hilog.error(DOMAIN, TAG, `âŒ æ—¶é’Ÿå¡ç‰‡æ›´æ–°å¤±è´¥: ${error.message}`);
    });
  }

  /**
   * å¡ç‰‡åˆ é™¤æ—¶è§¦å‘
   */
  onRemoveForm(formId: string): void {
    hilog.info(DOMAIN, TAG, `ğŸ—‘ï¸ æ—¶é’Ÿå¡ç‰‡åˆ é™¤: ${formId}`);
    
    // åœæ­¢å®šæ—¶æ›´æ–°
    this.stopPeriodicUpdate();
  }

  /**
   * å¡ç‰‡äº‹ä»¶å¤„ç†
   */
  onFormEvent(formId: string, message: string): void {
    hilog.info(DOMAIN, TAG, `ğŸ”” æ”¶åˆ°äº‹ä»¶ - formId: ${formId}, message: ${message}`);

    // å¤„ç†åˆ·æ–°äº‹ä»¶
    if (message === 'refresh') {
      hilog.info(DOMAIN, TAG, 'ğŸ”„ å¼€å§‹åˆ·æ–°æ—¶é—´...');
      this.onUpdateForm(formId);
    }
  }

  /**
   * è·å–å¡ç‰‡çŠ¶æ€
   */
  onAcquireFormState(want: Want): formInfo.FormState {
    hilog.info(DOMAIN, TAG, 'è·å–æ—¶é’Ÿå¡ç‰‡çŠ¶æ€');
    return formInfo.FormState.READY;
  }

  /**
   * å¯åŠ¨å®šæ—¶æ›´æ–°
   */
  private startPeriodicUpdate(formId: string): void {
    // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
    this.stopPeriodicUpdate();
    
    // æ¯ç§’æ›´æ–°ä¸€æ¬¡
    this.updateTimer = setInterval(() => {
      hilog.info(DOMAIN, TAG, 'â° å®šæ—¶æ›´æ–°æ—¶é’Ÿå¡ç‰‡');
      this.onUpdateForm(formId);
    }, 1000);
    
    hilog.info(DOMAIN, TAG, 'âœ… å·²å¯åŠ¨å®šæ—¶æ›´æ–°ï¼Œé—´éš”1ç§’');
  }

  /**
   * åœæ­¢å®šæ—¶æ›´æ–°
   */
  private stopPeriodicUpdate(): void {
    if (this.updateTimer !== -1) {
      clearInterval(this.updateTimer);
      this.updateTimer = -1;
      hilog.info(DOMAIN, TAG, 'â¹ï¸ å·²åœæ­¢å®šæ—¶æ›´æ–°');
    }
  }
}