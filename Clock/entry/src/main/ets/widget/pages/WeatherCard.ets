/**
 * å¤©æ°”å¡ç‰‡UIé¡µé¢
 * å±•ç¤ºåŸå¸‚å¤©æ°”ä¿¡æ¯
 */
import { weatherProvider } from '../../providers/WeatherProvider';

const TAG: string = 'WeatherCard';
const DOMAIN: number = 0x0003;

let storage = new LocalStorage();

@Entry(storage)
@Component
struct WeatherCard {
  // å¡ç‰‡æ•°æ®
  @LocalStorageProp('city') city: string = 'åŒ—äº¬';
  @LocalStorageProp('temperature') temperature: number = 25;
  @LocalStorageProp('weather') weather: string = 'æ™´å¤©';
  @LocalStorageProp('weatherCode') weatherCode: string = 'sunny';
  @LocalStorageProp('humidity') humidity: number = 60;
  @LocalStorageProp('windSpeed') windSpeed: number = 10;
  @LocalStorageProp('timestamp') timestamp: number = 0;
  @LocalStorageProp('lastUpdate') lastUpdate: string = 'åˆšåˆšæ›´æ–°';
  
  // å¡ç‰‡å°ºå¯¸
  @State cardWidth: number = 2;
  @State cardHeight: number = 2;

  aboutToAppear(): void {
    // å¡ç‰‡ä¸­ä¸æ”¯æŒhilogï¼Œä½¿ç”¨console.logæ›¿ä»£
    console.log(`[${TAG}] å¤©æ°”å¡ç‰‡åˆå§‹åŒ–å®Œæˆï¼Œå½“å‰åŸå¸‚: ${this.city}ï¼Œå¤©æ°”: ${this.weather}ï¼Œæ¸©åº¦: ${this.temperature}Â°C`);
    
    // è·å–å¡ç‰‡å°ºå¯¸ä¿¡æ¯
    this.getCardDimensions();
  }

  // è·å–å¡ç‰‡å°ºå¯¸
  getCardDimensions(): void {
    try {
      // å¡ç‰‡åº”ç”¨ä¸æ”¯æŒgetUIContext()ï¼Œä½¿ç”¨é»˜è®¤å°ºå¯¸2*2
      this.cardWidth = 2;
      this.cardHeight = 2;
      console.log(`[${TAG}] ä½¿ç”¨é»˜è®¤å¡ç‰‡å°ºå¯¸: ${this.cardWidth}*${this.cardHeight}`);
    } catch (error) {
      console.error(`[${TAG}] è·å–å¡ç‰‡å°ºå¯¸å¤±è´¥`);
    }
  }

  // æ ¹æ®å¡ç‰‡å°ºå¯¸åˆ¤æ–­å¸ƒå±€ç±»å‹
  getLayoutType(): string {
    if (this.cardWidth === 1 && this.cardHeight === 2) {
      return 'vertical'; // ç«–å‘é•¿æ¡å½¢
    } else if (this.cardWidth === 2 && this.cardHeight === 1) {
      return 'horizontal'; // æ¨ªå‘é•¿æ¡å½¢
    } else if (this.cardWidth === 2 && this.cardHeight === 4) {
      return 'verticalLarge'; // ç«–å‘å¤§é•¿æ¡
    } else if (this.cardWidth === 4 && this.cardHeight === 2) {
      return 'horizontalLarge'; // æ¨ªå‘å¤§é•¿æ¡
    } else {
      return 'square'; // æ­£æ–¹å½¢ (2*2, 4*4)
    }
  }

  // è·å–å¤©æ°”å›¾æ ‡
  getWeatherIcon(code: string): string {
    return weatherProvider.getWeatherIcon(code);
  }

  build() {
    Stack() {
      // ä¸»è¦å†…å®¹åŒºåŸŸ
      Column({ space: 8 }) {
        if (this.getLayoutType() === 'vertical') {
          // ç«–å‘é•¿æ¡å½¢å¸ƒå±€ (1*2)
          this.buildVerticalLayout();
        } else if (this.getLayoutType() === 'horizontal') {
          // æ¨ªå‘é•¿æ¡å½¢å¸ƒå±€ (2*1)
          this.buildHorizontalLayout();
        } else if (this.getLayoutType() === 'verticalLarge') {
          // ç«–å‘å¤§é•¿æ¡å¸ƒå±€ (2*4)
          this.buildVerticalLargeLayout();
        } else if (this.getLayoutType() === 'horizontalLarge') {
          // æ¨ªå‘å¤§é•¿æ¡å¸ƒå±€ (4*2)
          this.buildHorizontalLargeLayout();
        } else {
          // æ­£æ–¹å½¢å¸ƒå±€ (2*2, 4*4)
          this.buildSquareLayout();
        }
      }
      .width('100%')
      .height('100%')
      .padding(12)
      .justifyContent(FlexAlign.Start)
      .backgroundColor($r('app.color.card_background'))
      .borderRadius(12)
      .shadow({
        radius: 6,
        color: $r('app.color.shadow'),
        offsetX: 0,
        offsetY: 2
      })
      .onClick(() => {
        // ç‚¹å‡»å¡ç‰‡è·³è½¬åˆ°åº”ç”¨
        // å¡ç‰‡ä¸­ä¸æ”¯æŒhilogï¼Œä½¿ç”¨console.logæ›¿ä»£
        console.log(`[${TAG}] ç”¨æˆ·ç‚¹å‡»å¤©æ°”å¡ç‰‡ï¼Œå½“å‰åŸå¸‚: ${this.city}ï¼Œå‡†å¤‡è·³è½¬åˆ°åº”ç”¨`);
        postCardAction(this, {
          action: 'router',
          abilityName: 'EntryAbility',
          params: {
            page: 'pages/Index'
          }
        });
      })
    }
    .width('100%')
    .height('100%')
    .alignContent(Alignment.BottomEnd)
    .padding({ right: 12, bottom: 8 })
  }

  // ç«–å‘é•¿æ¡å½¢å¸ƒå±€ (1*2)
  @Builder buildVerticalLayout() {
    Column({ space: 6 }) {
      // åŸå¸‚å’Œæ›´æ–°æ—¶é—´
      Column({ space: 2 }) {
        Text(this.city)
          .fontSize(14)
          .fontWeight(FontWeight.Bold)
          .fontColor($r('app.color.text_primary'))
          .textAlign(TextAlign.Center)
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })

        Text(this.lastUpdate)
          .fontSize(8)
          .fontColor($r('app.color.text_tertiary'))
          .textAlign(TextAlign.Center)
          .maxLines(1)
      }
      .width('100%')

      // å¤©æ°”å›¾æ ‡å’Œæ¸©åº¦
      Column({ space: 4 }) {
        Text(this.getWeatherIcon(this.weatherCode))
          .fontSize(28)
          .width(36)
          .height(36)
          .textAlign(TextAlign.Center)

        Text(`${this.temperature}Â°`)
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor($r('app.color.text_primary'))
          .textAlign(TextAlign.Center)
          .maxLines(1)

        Text(this.weather)
          .fontSize(10)
          .fontColor($r('app.color.text_secondary'))
          .textAlign(TextAlign.Center)
          .maxLines(1)
      }
      .width('100%')

      // è¯¦ç»†ä¿¡æ¯
      Row({ space: 12 }) {
        // æ¹¿åº¦
        Column({ space: 1 }) {
          Text('ğŸ’§')
            .fontSize(12)
          Text(`${this.humidity}%`)
            .fontSize(10)
            .fontColor($r('app.color.text_secondary'))
        }
        .alignItems(HorizontalAlign.Center)

        // é£é€Ÿ
        Column({ space: 1 }) {
          Text('ğŸ’¨')
            .fontSize(12)
          Text(`${this.windSpeed}km/h`)
            .fontSize(10)
            .fontColor($r('app.color.text_secondary'))
        }
        .alignItems(HorizontalAlign.Center)
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceEvenly)
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.SpaceEvenly)
  }

  // æ¨ªå‘é•¿æ¡å½¢å¸ƒå±€ (2*1)
  @Builder buildHorizontalLayout() {
    Row({ space: 8 }) {
      // å¤©æ°”å›¾æ ‡å’Œæ¸©åº¦
      Row({ space: 6 }) {
        Text(this.getWeatherIcon(this.weatherCode))
          .fontSize(26)
          .width(32)
          .height(32)
          .textAlign(TextAlign.Center)

        Column({ space: 1 }) {
          Text(`${this.temperature}Â°`)
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor($r('app.color.text_primary'))
            .maxLines(1)

          Text(this.weather)
            .fontSize(10)
            .fontColor($r('app.color.text_secondary'))
            .maxLines(1)
        }
        .alignItems(HorizontalAlign.Start)
        .justifyContent(FlexAlign.Center)
      }
      .layoutWeight(1)

      // åŸå¸‚å’Œè¯¦ç»†ä¿¡æ¯
      Column({ space: 2 }) {
        Text(this.city)
          .fontSize(11)
          .fontWeight(FontWeight.Bold)
          .fontColor($r('app.color.text_primary'))
          .textAlign(TextAlign.End)
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })

        Row({ space: 6 }) {
          // æ¹¿åº¦
          Row({ space: 1 }) {
            Text('ğŸ’§')
              .fontSize(10)
            Text(`${this.humidity}%`)
              .fontSize(8)
              .fontColor($r('app.color.text_secondary'))
          }
          .alignItems(VerticalAlign.Center)

          // é£é€Ÿ
          Row({ space: 1 }) {
            Text('ğŸ’¨')
              .fontSize(10)
            Text(`${this.windSpeed}km/h`)
              .fontSize(8)
              .fontColor($r('app.color.text_secondary'))
          }
          .alignItems(VerticalAlign.Center)
        }
        .justifyContent(FlexAlign.End)

        Text(this.lastUpdate)
          .fontSize(7)
          .fontColor($r('app.color.text_tertiary'))
          .textAlign(TextAlign.End)
          .maxLines(1)
      }
      .constraintSize({ maxWidth: '50%' })
      .alignItems(HorizontalAlign.End)
      .justifyContent(FlexAlign.Center)
    }
    .width('100%')
    .height('100%')
    .alignItems(VerticalAlign.Center)
  }

  // ç«–å‘å¤§é•¿æ¡å¸ƒå±€ (2*4)
  @Builder buildVerticalLargeLayout() {
    Column({ space: 12 }) {
      // åŸå¸‚å’Œæ›´æ–°æ—¶é—´
      Row() {
        Column({ space: 2 }) {
          Text(this.city)
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor($r('app.color.text_primary'))
            .textAlign(TextAlign.Start)
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })

          Text(this.lastUpdate)
            .fontSize(11)
            .fontColor($r('app.color.text_tertiary'))
            .textAlign(TextAlign.Start)
            .maxLines(1)
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)

        // åˆ·æ–°æŒ‰é’®
        Button({ type: ButtonType.Circle }) {
          Text('ğŸ”„')
            .fontSize(16)
        }
        .width(32)
        .height(32)
        .backgroundColor($r('app.color.card_background'))
        .onClick(() => {
          // ç‚¹å‡»åˆ·æ–°æŒ‰é’®
          // å¡ç‰‡ä¸­ä¸æ”¯æŒhilogï¼Œä½¿ç”¨console.logæ›¿ä»£
          console.log(`[${TAG}] ç”¨æˆ·ç‚¹å‡»å¤©æ°”å¡ç‰‡åˆ·æ–°æŒ‰é’®ï¼Œå½“å‰åŸå¸‚: ${this.city}`);
          postCardAction(this, {
            action: 'refresh',
            params: {
              'refresh': 'true'
            }
          });
        })
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)

      // å¤©æ°”å›¾æ ‡å’Œæ¸©åº¦
      Column({ space: 10 }) {
        Text(this.getWeatherIcon(this.weatherCode))
          .fontSize(56)
          .width(72)
          .height(72)
          .textAlign(TextAlign.Center)

        Text(`${this.temperature}Â°`)
          .fontSize(48)
          .fontWeight(FontWeight.Bold)
          .fontColor($r('app.color.text_primary'))
          .maxLines(1)

        Text(this.weather)
          .fontSize(16)
          .fontColor($r('app.color.text_secondary'))
          .maxLines(1)
      }
      .width('100%')
      .alignItems(HorizontalAlign.Center)
      .layoutWeight(1)
      .justifyContent(FlexAlign.Center)

      // è¯¦ç»†ä¿¡æ¯
      Row({ space: 20 }) {
        // æ¹¿åº¦
        Column({ space: 4 }) {
          Text('ğŸ’§')
            .fontSize(20)
          Text(`${this.humidity}%`)
            .fontSize(14)
            .fontColor($r('app.color.text_secondary'))
          Text('æ¹¿åº¦')
            .fontSize(12)
            .fontColor($r('app.color.text_tertiary'))
        }
        .alignItems(HorizontalAlign.Center)

        // é£é€Ÿ
        Column({ space: 4 }) {
          Text('ğŸ’¨')
            .fontSize(20)
          Text(`${this.windSpeed}km/h`)
            .fontSize(14)
            .fontColor($r('app.color.text_secondary'))
          Text('é£é€Ÿ')
            .fontSize(12)
            .fontColor($r('app.color.text_tertiary'))
        }
        .alignItems(HorizontalAlign.Center)

        Blank()

        // æ—¶é—´æˆ³ï¼ˆç”¨äºéªŒè¯æ›´æ–°ï¼Œè‡ªé€‚åº”å±å¹•ï¼‰
        Text(`æ—¶é—´æˆ³: ${this.timestamp}`)
          .fontSize(10)
          .fontColor($r('app.color.text_tertiary'))
          .maxFontSize(12)
          .minFontSize(8)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .maxLines(1)
      }
      .width('100%')
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.SpaceEvenly)
  }

  // æ¨ªå‘å¤§é•¿æ¡å¸ƒå±€ (4*2)
  @Builder buildHorizontalLargeLayout() {
    Row({ space: 16 }) {
      // å·¦ä¾§ï¼šåŸå¸‚å’Œæ›´æ–°æ—¶é—´
      Column({ space: 6 }) {
        Text(this.city)
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor($r('app.color.text_primary'))
          .textAlign(TextAlign.Start)
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })

        Text(this.lastUpdate)
          .fontSize(11)
          .fontColor($r('app.color.text_tertiary'))
          .textAlign(TextAlign.Start)
          .maxLines(1)

        // åˆ·æ–°æŒ‰é’®
        Button({ type: ButtonType.Circle }) {
          Text('ğŸ”„')
            .fontSize(14)
        }
        .width(30)
        .height(30)
        .backgroundColor($r('app.color.card_background'))
        .onClick(() => {
          // ç‚¹å‡»åˆ·æ–°æŒ‰é’®
          // å¡ç‰‡ä¸­ä¸æ”¯æŒhilogï¼Œä½¿ç”¨console.logæ›¿ä»£
          console.log(`[${TAG}] ç”¨æˆ·ç‚¹å‡»å¤©æ°”å¡ç‰‡åˆ·æ–°æŒ‰é’®ï¼Œå½“å‰åŸå¸‚: ${this.city}`);
          postCardAction(this, {
            action: 'refresh',
            params: {
              'refresh': 'true'
            }
          });
        })
      }
      .constraintSize({ maxWidth: '25%' })
      .alignItems(HorizontalAlign.Start)
      .justifyContent(FlexAlign.Center)

      // ä¸­é—´ï¼šå¤©æ°”å›¾æ ‡å’Œæ¸©åº¦
      Row({ space: 12 }) {
        Text(this.getWeatherIcon(this.weatherCode))
          .fontSize(48)
          .width(60)
          .height(60)
          .textAlign(TextAlign.Center)

        Column({ space: 4 }) {
          Text(`${this.temperature}Â°`)
            .fontSize(36)
            .fontWeight(FontWeight.Bold)
            .fontColor($r('app.color.text_primary'))
            .maxLines(1)

          Text(this.weather)
            .fontSize(14)
            .fontColor($r('app.color.text_secondary'))
            .maxLines(1)
        }
        .alignItems(HorizontalAlign.Start)
        .justifyContent(FlexAlign.Center)
      }
      .layoutWeight(1)
      .alignItems(VerticalAlign.Center)

      // å³ä¾§ï¼šè¯¦ç»†ä¿¡æ¯
      Column({ space: 12 }) {
        // æ¹¿åº¦
        Column({ space: 4 }) {
          Text('ğŸ’§')
            .fontSize(16)
          Text(`${this.humidity}%`)
            .fontSize(13)
            .fontColor($r('app.color.text_secondary'))
          Text('æ¹¿åº¦')
            .fontSize(11)
            .fontColor($r('app.color.text_tertiary'))
        }
        .alignItems(HorizontalAlign.Center)

        // é£é€Ÿ
        Column({ space: 4 }) {
          Text('ğŸ’¨')
            .fontSize(16)
          Text(`${this.windSpeed}km/h`)
            .fontSize(13)
            .fontColor($r('app.color.text_secondary'))
          Text('é£é€Ÿ')
            .fontSize(11)
            .fontColor($r('app.color.text_tertiary'))
        }
        .alignItems(HorizontalAlign.Center)

        // æ—¶é—´æˆ³
        Text(`æ—¶é—´æˆ³: ${this.timestamp}`)
          .fontSize(8)
          .fontColor($r('app.color.text_tertiary'))
          .maxFontSize(10)
          .minFontSize(7)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .maxLines(1)
      }
      .constraintSize({ maxWidth: '30%' })
      .alignItems(HorizontalAlign.Center)
      .justifyContent(FlexAlign.Center)
    }
    .width('100%')
    .height('100%')
    .alignItems(VerticalAlign.Center)
  }

  // æ­£æ–¹å½¢å¸ƒå±€ (2*2, 4*4)
  @Builder buildSquareLayout() {
    Column({ space: 8 }) {
      // åŸå¸‚å’Œæ›´æ–°æ—¶é—´
      Row() {
        Column({ space: 2 }) {
          Text(this.city)
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor($r('app.color.text_primary'))
            .textAlign(TextAlign.Start)
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })

          Text(this.lastUpdate)
            .fontSize(9)
            .fontColor($r('app.color.text_tertiary'))
            .textAlign(TextAlign.Start)
            .maxLines(1)
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)

        // åˆ·æ–°æŒ‰é’®
        Button({ type: ButtonType.Circle }) {
          Text('ğŸ”„')
            .fontSize(14)
        }
        .width(28)
        .height(28)
        .backgroundColor($r('app.color.card_background'))
        .onClick(() => {
          // ç‚¹å‡»åˆ·æ–°æŒ‰é’®
          // å¡ç‰‡ä¸­ä¸æ”¯æŒhilogï¼Œä½¿ç”¨console.logæ›¿ä»£
          console.log(`[${TAG}] ç”¨æˆ·ç‚¹å‡»å¤©æ°”å¡ç‰‡åˆ·æ–°æŒ‰é’®ï¼Œå½“å‰åŸå¸‚: ${this.city}`);
          postCardAction(this, {
            action: 'refresh',
            params: {
              'refresh': 'true'
            }
          });
        })
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)

      // å¤©æ°”å›¾æ ‡å’Œæ¸©åº¦
      Row({ space: 12 }) {
        // å¤©æ°”å›¾æ ‡
        Text(this.getWeatherIcon(this.weatherCode))
          .fontSize(40)
          .width(52)
          .height(52)
          .textAlign(TextAlign.Center)

        // æ¸©åº¦
        Column({ space: 2 }) {
          Text(`${this.temperature}Â°`)
            .fontSize(36)
            .fontWeight(FontWeight.Bold)
            .fontColor($r('app.color.text_primary'))
            .maxLines(1)

          Text(this.weather)
            .fontSize(13)
            .fontColor($r('app.color.text_secondary'))
            .maxLines(1)
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
      }
      .width('100%')
      .alignItems(VerticalAlign.Center)
      .layoutWeight(1)

      // è¯¦ç»†ä¿¡æ¯
      Row({ space: 16 }) {
        // æ¹¿åº¦
        Column({ space: 3 }) {
          Text('ğŸ’§')
            .fontSize(16)
          Text(`${this.humidity}%`)
            .fontSize(12)
            .fontColor($r('app.color.text_secondary'))
          Text('æ¹¿åº¦')
            .fontSize(10)
            .fontColor($r('app.color.text_tertiary'))
        }
        .alignItems(HorizontalAlign.Center)

        // é£é€Ÿ
        Column({ space: 3 }) {
          Text('ğŸ’¨')
            .fontSize(16)
          Text(`${this.windSpeed}km/h`)
            .fontSize(12)
            .fontColor($r('app.color.text_secondary'))
          Text('é£é€Ÿ')
            .fontSize(10)
            .fontColor($r('app.color.text_tertiary'))
        }
        .alignItems(HorizontalAlign.Center)

        Blank()

        // æ—¶é—´æˆ³ï¼ˆç”¨äºéªŒè¯æ›´æ–°ï¼Œè‡ªé€‚åº”å±å¹•ï¼‰
        Text(`æ—¶é—´æˆ³: ${this.timestamp}`)
          .fontSize(8)
          .fontColor($r('app.color.text_tertiary'))
          .maxFontSize(10)
          .minFontSize(7)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .maxLines(1)
      }
      .width('100%')
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.SpaceEvenly)
  }
}