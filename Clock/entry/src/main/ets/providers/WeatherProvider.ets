/**
 * å¤©æ°”æ•°æ®æä¾›è€…
 * è´Ÿè´£è·å–å’Œç”Ÿæˆå¤©æ°”æ•°æ®
 */
export interface WeatherData {
  city: string;
  temperature: number;
  weather: string;
  weatherCode: string;
  humidity: number;
  windSpeed: number;
  timestamp: number;
}

// å¤©æ°”ç±»å‹æ¥å£
export interface WeatherType {
  name: string;
  code: string;
  icon: string;
}

export class WeatherProvider {
  private cities: string[] = ['åŒ—äº¬', 'ä¸Šæµ·', 'å¹¿å·', 'æ·±åœ³', 'æˆéƒ½', 'æ­å·', 'å—äº¬', 'æ­¦æ±‰', 'è¥¿å®‰', 'é‡åº†'];
  private weatherTypes: Map<string, WeatherType> = new Map([
    ['sunny', { name: 'æ™´å¤©', code: 'sunny', icon: 'â˜€ï¸' } as WeatherType],
    ['cloudy', { name: 'å¤šäº‘', code: 'cloudy', icon: 'â˜ï¸' } as WeatherType],
    ['rainy', { name: 'é›¨å¤©', code: 'rainy', icon: 'ğŸŒ§ï¸' } as WeatherType],
    ['snowy', { name: 'é›ªå¤©', code: 'snowy', icon: 'â„ï¸' } as WeatherType],
    ['foggy', { name: 'é›¾å¤©', code: 'foggy', icon: 'ğŸŒ«ï¸' } as WeatherType],
    ['windy', { name: 'å¤§é£', code: 'windy', icon: 'ğŸ’¨' } as WeatherType]
  ]);

  /**
   * è·å–éšæœºå¤©æ°”æ•°æ®
   * @returns éšæœºç”Ÿæˆçš„å¤©æ°”æ•°æ®
   */
  getRandomWeather(): WeatherData {
    // éšæœºé€‰æ‹©åŸå¸‚
    const cityIndex = Math.floor(Math.random() * this.cities.length);
    const city = this.cities[cityIndex];
    
    // éšæœºç”Ÿæˆæ¸©åº¦ (-10Â°C åˆ° 40Â°C)
    const temperature = Math.floor(Math.random() * 50) - 10;
    
    // éšæœºé€‰æ‹©å¤©æ°”ç±»å‹
    const weatherKeys = Array.from(this.weatherTypes.keys());
    const weatherKey = weatherKeys[Math.floor(Math.random() * weatherKeys.length)];
    const weatherType = this.weatherTypes.get(weatherKey)!;
    const weather = weatherType.name;
    const weatherCode = weatherType.code;
    
    // éšæœºç”Ÿæˆæ¹¿åº¦ (30% - 90%)
    const humidity = Math.floor(Math.random() * 60) + 30;
    
    // éšæœºç”Ÿæˆé£é€Ÿ (0 - 30 km/h)
    const windSpeed = Math.floor(Math.random() * 31);
    
    // è·å–å½“å‰æ—¶é—´æˆ³
    const timestamp = Date.now();
    
    return {
      city,
      temperature,
      weather,
      weatherCode,
      humidity,
      windSpeed,
      timestamp
    };
  }

  /**
   * è·å–å¤©æ°”å›¾æ ‡
   * @param weatherCode å¤©æ°”ä»£ç 
   * @returns å¤©æ°”å›¾æ ‡
   */
  getWeatherIcon(weatherCode: string): string {
    const weatherType = this.weatherTypes.get(weatherCode);
    return weatherType ? weatherType.icon : 'ğŸŒ¤ï¸';
  }

  /**
   * è·å–åŸå¸‚åˆ—è¡¨
   * @returns åŸå¸‚åˆ—è¡¨
   */
  getCities(): string[] {
    return [...this.cities];
  }

  /**
   * æ ¹æ®åŸå¸‚è·å–å¤©æ°”
   * @param city åŸå¸‚åç§°
   * @returns æŒ‡å®šåŸå¸‚çš„å¤©æ°”æ•°æ®
   */
  getWeatherByCity(city: string): WeatherData {
    // ä½¿ç”¨åŸå¸‚åç§°ä½œä¸ºéšæœºç§å­ï¼Œç¡®ä¿åŒä¸€åŸå¸‚åœ¨åŒä¸€æ—¶é—´æ€»æ˜¯è¿”å›ç›¸åŒçš„å¤©æ°”
    const seed = city.charCodeAt(0) + Date.now();
    const random = (seed: number) => {
      const x = Math.sin(seed) * 10000;
      return x - Math.floor(x);
    };
    
    // éšæœºç”Ÿæˆæ¸©åº¦ (-10Â°C åˆ° 40Â°C)
    const temperature = Math.floor(random(seed * 2) * 50) - 10;
    
    // éšæœºé€‰æ‹©å¤©æ°”ç±»å‹
    const weatherKeys = Array.from(this.weatherTypes.keys());
    const weatherKey = weatherKeys[Math.floor(random(seed * 3) * weatherKeys.length)];
    const weatherType = this.weatherTypes.get(weatherKey)!;
    const weather = weatherType.name;
    const weatherCode = weatherType.code;
    
    // éšæœºç”Ÿæˆæ¹¿åº¦ (30% - 90%)
    const humidity = Math.floor(random(seed * 5) * 60) + 30;
    
    // éšæœºç”Ÿæˆé£é€Ÿ (0 - 30 km/h)
    const windSpeed = Math.floor(random(seed * 7) * 31);
    
    // è·å–å½“å‰æ—¶é—´æˆ³
    const timestamp = Date.now();
    
    return {
      city,
      temperature,
      weather,
      weatherCode,
      humidity,
      windSpeed,
      timestamp
    };
  }
}

// å¯¼å‡ºå•ä¾‹å®ä¾‹
export const weatherProvider = new WeatherProvider();