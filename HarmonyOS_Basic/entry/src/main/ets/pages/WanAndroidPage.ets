import { WanAndroidService } from '../service/WanAndroidService';
import { Article, Banner, HotKey, PageData } from '../model/WanAndroidModels';

@Entry
@Component
struct WanAndroidPage {
  @State articles: Article[] = [];
  @State banners: Banner[] = [];
  @State hotKeys: HotKey[] = [];
  @State loading: boolean = false;
  @State errorMessage: string = '';
  @State currentPage: number = 0;
  @State hasMore: boolean = true;
  private isDestroyed: boolean = false;

  async aboutToAppear() {
    this.isDestroyed = false;
    await this.loadData();
  }

  aboutToDisappear() {
    // æ ‡è®°ç»„ä»¶å·²é”€æ¯ï¼Œé¿å…å¼‚æ­¥æ“ä½œç»§ç»­æ‰§è¡Œ
    this.isDestroyed = true;
    // æ¸…ç†æ•°æ®ï¼Œé‡Šæ”¾å†…å­˜
    this.articles = [];
    this.banners = [];
    this.hotKeys = [];
  }

  /**
   * åŠ è½½æ•°æ®
   */
  async loadData() {
    if (this.isDestroyed) return;
    
    this.loading = true;
    this.errorMessage = '';

    try {
      console.info('å¼€å§‹åŠ è½½æ•°æ®...');
      
      // é¦–å…ˆæµ‹è¯•ç½‘ç»œè¿žæŽ¥
      const isConnected = await WanAndroidService.testConnection();
      if (!isConnected) {
        this.errorMessage = 'ç½‘ç»œè¿žæŽ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®';
        return;
      }
      
      // ä¸²è¡ŒåŠ è½½ä»¥å‡å°‘å†…å­˜åŽ‹åŠ›
      console.info('å¼€å§‹åŠ è½½æ–‡ç« æ•°æ®...');
      const articlesResponse = await WanAndroidService.getHomeArticles(0);
      if (this.isDestroyed) return;

      // å¤„ç†æ–‡ç« æ•°æ®
      if (articlesResponse.errorCode === 0) {
        this.articles = articlesResponse.data.datas.slice(0, 10); // é™åˆ¶åˆå§‹åŠ è½½æ•°é‡
        this.hasMore = !articlesResponse.data.over;
        console.info(`æˆåŠŸåŠ è½½ ${this.articles.length} ç¯‡æ–‡ç« `);
      } else {
        this.errorMessage = articlesResponse.errorMsg || 'èŽ·å–æ–‡ç« å¤±è´¥';
        console.error('æ–‡ç« æ•°æ®é”™è¯¯:', articlesResponse.errorMsg);
        return;
      }

      // åŠ è½½Banneræ•°æ®
      console.info('å¼€å§‹åŠ è½½Banneræ•°æ®...');
      const bannersResponse = await WanAndroidService.getBanner();
      if (this.isDestroyed) return;
      
      if (bannersResponse.errorCode === 0) {
        this.banners = bannersResponse.data.slice(0, 3); // é™åˆ¶Banneræ•°é‡
        console.info(`æˆåŠŸåŠ è½½ ${this.banners.length} ä¸ªBanner`);
      } else {
        console.warn('BanneråŠ è½½å¤±è´¥:', bannersResponse.errorMsg);
      }

      // åŠ è½½çƒ­è¯æ•°æ®
      console.info('å¼€å§‹åŠ è½½çƒ­è¯æ•°æ®...');
      const hotKeysResponse = await WanAndroidService.getHotKeys();
      if (this.isDestroyed) return;
      
      if (hotKeysResponse.errorCode === 0) {
        this.hotKeys = hotKeysResponse.data.slice(0, 8); // é™åˆ¶çƒ­è¯æ•°é‡
        console.info(`æˆåŠŸåŠ è½½ ${this.hotKeys.length} ä¸ªçƒ­è¯`);
      } else {
        console.warn('çƒ­è¯åŠ è½½å¤±è´¥:', hotKeysResponse.errorMsg);
      }

      console.info('æ‰€æœ‰æ•°æ®åŠ è½½å®Œæˆ');

    } catch (error) {
      if (this.isDestroyed) return;
      console.error('Load data error:', error);
      
      // æ ¹æ®é”™è¯¯ç±»åž‹æä¾›æ›´å…·ä½“çš„é”™è¯¯ä¿¡æ¯
      if (typeof error === 'string') {
        this.errorMessage = error;
      } else {
        this.errorMessage = 'ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿žæŽ¥';
      }
    } finally {
      if (!this.isDestroyed) {
        this.loading = false;
      }
    }
  }

  /**
   * åŠ è½½æ›´å¤šæ–‡ç« 
   */
  async loadMoreArticles() {
    if (this.loading || !this.hasMore || this.isDestroyed) return;

    this.loading = true;
    try {
      const response = await WanAndroidService.getHomeArticles(this.currentPage + 1);
      if (this.isDestroyed) return;
      
      if (response.errorCode === 0) {
        // é™åˆ¶æ€»æ–‡ç« æ•°é‡ï¼Œé¿å…å†…å­˜è¿‡è½½
        const newArticles = response.data.datas.slice(0, 10);
        const totalArticles = [...this.articles, ...newArticles];
        
        // å¦‚æžœæ–‡ç« æ€»æ•°è¶…è¿‡50ï¼Œç§»é™¤æœ€æ—§çš„æ–‡ç« 
        if (totalArticles.length > 50) {
          this.articles = totalArticles.slice(-50);
        } else {
          this.articles = totalArticles;
        }
        
        this.currentPage++;
        this.hasMore = !response.data.over;
      }
    } catch (error) {
      if (this.isDestroyed) return;
      console.error('Load more error:', error);
    } finally {
      if (!this.isDestroyed) {
        this.loading = false;
      }
    }
  }

  /**
   * åˆ·æ–°æ•°æ®
   */
  async refreshData() {
    if (this.isDestroyed) return;
    
    this.currentPage = 0;
    this.articles = [];
    this.banners = [];
    this.hotKeys = [];
    await this.loadData();
  }

  build() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Text('çŽ©å®‰å“')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor(Color.White)
      }
      .width('100%')
      .height(56)
      .backgroundColor('#1976D2')
      .justifyContent(FlexAlign.Center)

      if (this.loading && this.articles.length === 0) {
        // åŠ è½½çŠ¶æ€
        Column() {
          LoadingProgress()
            .width(50)
            .height(50)
            .color('#1976D2')
          Text('åŠ è½½ä¸­...')
            .fontSize(14)
            .fontColor('#666')
            .margin({ top: 10 })
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
      } else if (this.errorMessage) {
        // é”™è¯¯çŠ¶æ€
        Column() {
          Text('ðŸ˜ž')
            .fontSize(48)
          Text('ç½‘ç»œè¯·æ±‚å¤±è´¥')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333')
            .margin({ top: 10 })
          
          Text(this.errorMessage)
            .fontSize(14)
            .fontColor('#666')
            .margin({ top: 8 })
            .textAlign(TextAlign.Center)
            .padding({ left: 20, right: 20 })
          
          Column() {
            Text('å¯èƒ½çš„è§£å†³æ–¹æ¡ˆ:')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .margin({ top: 20, bottom: 10 })
            
            Text('1. æ£€æŸ¥è®¾å¤‡ç½‘ç»œè¿žæŽ¥')
              .fontSize(14)
              .fontColor('#666')
              .margin({ bottom: 5 })
              .alignSelf(ItemAlign.Start)
            
            Text('2. ç¡®è®¤ç½‘ç»œæƒé™å·²æŽˆäºˆ')
              .fontSize(14)
              .fontColor('#666')
              .margin({ bottom: 5 })
              .alignSelf(ItemAlign.Start)
            
            Text('3. å°è¯•åˆ‡æ¢ç½‘ç»œçŽ¯å¢ƒ')
              .fontSize(14)
              .fontColor('#666')
              .margin({ bottom: 5 })
              .alignSelf(ItemAlign.Start)
            
            Text('4. æ£€æŸ¥é˜²ç«å¢™è®¾ç½®')
              .fontSize(14)
              .fontColor('#666')
              .margin({ bottom: 20 })
              .alignSelf(ItemAlign.Start)
          }
          .padding({ left: 20, right: 20 })
          
          Button('é‡è¯•')
            .margin({ top: 10 })
            .backgroundColor('#1976D2')
            .onClick(() => this.refreshData())
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
      } else {
        // å†…å®¹åŒºåŸŸ
        Refresh({ refreshing: this.loading }) {
          List() {
            // BanneråŒºåŸŸ
            if (this.banners.length > 0) {
              ListItem() {
                this.BannerSection()
              }
            }

            // çƒ­è¯åŒºåŸŸ
            if (this.hotKeys.length > 0) {
              ListItem() {
                this.HotKeysSection()
              }
            }

            // æ–‡ç« åˆ—è¡¨
            ForEach(this.articles, (article: Article, index: number) => {
              ListItem() {
                this.ArticleItem(article)
              }
              .onClick(() => {
                console.info(`ç‚¹å‡»æ–‡ç« : ${article.title}`);
                // è¿™é‡Œå¯ä»¥è·³è½¬åˆ°æ–‡ç« è¯¦æƒ…é¡µæˆ–æ‰“å¼€æµè§ˆå™¨
              })
            })

            // åŠ è½½æ›´å¤š
            if (this.hasMore) {
              ListItem() {
                Row() {
                  if (this.loading) {
                    LoadingProgress()
                      .width(20)
                      .height(20)
                      .margin({ right: 10 })
                  }
                  Text(this.loading ? 'åŠ è½½ä¸­...' : 'ä¸Šæ‹‰åŠ è½½æ›´å¤š')
                    .fontSize(14)
                    .fontColor('#999')
                }
                .width('100%')
                .height(50)
                .justifyContent(FlexAlign.Center)
              }
              .onClick(() => this.loadMoreArticles())
            }
          }
          .width('100%')
          .layoutWeight(1)
          .onReachEnd(() => {
            this.loadMoreArticles();
          })
        }
        .onRefreshing(() => this.refreshData())
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }

  /**
   * Bannerç»„ä»¶
   */
  @Builder
  BannerSection() {
    Column() {
      Text('è½®æ’­å›¾')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .margin({ bottom: 10 })
        .alignSelf(ItemAlign.Start)

      Swiper() {
        ForEach(this.banners.slice(0, 3), (banner: Banner) => {
          Stack() {
            Image(banner.imagePath)
              .width('100%')
              .height(180)
              .objectFit(ImageFit.Cover)
              .borderRadius(8)
              .onError(() => {
                console.error('Banner image load failed:', banner.imagePath);
              })
              .onComplete(() => {
                console.info('Banner image loaded successfully');
              })
            
            Column() {
              Text(banner.title)
                .fontSize(16)
                .fontColor(Color.White)
                .fontWeight(FontWeight.Bold)
                .maxLines(2)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
            }
            .width('100%')
            .height('100%')
            .padding(16)
            .justifyContent(FlexAlign.End)
            .alignItems(HorizontalAlign.Start)
            .backgroundColor('rgba(0,0,0,0.3)')
            .borderRadius(8)
          }
        })
      }
      .width('100%')
      .height(180)
      .autoPlay(true)
      .interval(3000)
      .indicator(true)
      .borderRadius(8)
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .margin({ bottom: 8 })
  }

  /**
   * çƒ­è¯ç»„ä»¶
   */
  @Builder
  HotKeysSection() {
    Column() {
      Text('çƒ­é—¨æœç´¢')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .margin({ bottom: 10 })
        .alignSelf(ItemAlign.Start)

      Flex({ wrap: FlexWrap.Wrap, alignItems: ItemAlign.Center }) {
        ForEach(this.hotKeys.slice(0, 10), (hotKey: HotKey) => {
          Text(hotKey.name)
            .fontSize(12)
            .fontColor('#1976D2')
            .padding({ left: 12, right: 12, top: 6, bottom: 6 })
            .backgroundColor('#E3F2FD')
            .borderRadius(16)
            .margin({ right: 8, bottom: 8 })
            .onClick(() => {
              console.info(`ç‚¹å‡»çƒ­è¯: ${hotKey.name}`);
              // è¿™é‡Œå¯ä»¥æ‰§è¡Œæœç´¢æ“ä½œ
            })
        })
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .margin({ bottom: 8 })
  }

  /**
   * æ–‡ç« é¡¹ç»„ä»¶
   */
  @Builder
  ArticleItem(article: Article) {
    Column() {
      Row() {
        Column() {
          Text(article.title)
            .fontSize(16)
            .fontColor('#333')
            .fontWeight(FontWeight.Medium)
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .lineHeight(22)

          if (article.desc) {
            Text(article.desc)
              .fontSize(14)
              .fontColor('#666')
              .maxLines(2)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
              .margin({ top: 8 })
              .lineHeight(20)
          }

          Row() {
            Text(`ä½œè€…: ${article.author || article.shareUser || 'æœªçŸ¥'}`)
              .fontSize(12)
              .fontColor('#999')
            
            Blank()
            
            Text(article.niceDate)
              .fontSize(12)
              .fontColor('#999')
          }
          .width('100%')
          .margin({ top: 12 })
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Start)

        if (article.envelopePic) {
          Image(article.envelopePic)
            .width(80)
            .height(60)
            .objectFit(ImageFit.Cover)
            .borderRadius(4)
            .margin({ left: 12 })
            .onError(() => {
              console.error('Article image load failed:', article.envelopePic);
            })
            .alt('å›¾ç‰‡åŠ è½½å¤±è´¥')
        }
      }
      .width('100%')
      .alignItems(VerticalAlign.Top)

      Row() {
        if (article.fresh) {
          Text('æ–°')
            .fontSize(10)
            .fontColor(Color.White)
            .backgroundColor('#FF5722')
            .padding({ left: 4, right: 4, top: 2, bottom: 2 })
            .borderRadius(2)
            .margin({ right: 8 })
        }

        Text(`${article.superChapterName} / ${article.chapterName}`)
          .fontSize(12)
          .fontColor('#1976D2')
          .backgroundColor('#E3F2FD')
          .padding({ left: 8, right: 8, top: 4, bottom: 4 })
          .borderRadius(12)

        Blank()

        if (article.collect) {
          Text('â™¥')
            .fontSize(16)
            .fontColor('#F44336')
        }
      }
      .width('100%')
      .margin({ top: 12 })
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(8)
    .margin({ left: 16, right: 16, bottom: 8 })
  }
}
